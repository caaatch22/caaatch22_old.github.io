<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>C++ CRTP</title>
    <link href="/C-CRTP/"/>
    <url>/C-CRTP/</url>
    
    <content type="html"><![CDATA[<blockquote><p>åŸå…ˆåªæ˜¯äº†è§£è¿™ä¸ªåè¯ï¼Œæƒ³ç€C<ins>20åé™æ€å¤šæ€ç›´æ¥ç”¨ <code>concept</code>æ¥å®ç°å°±å¥½äº†å°±æ²¡ç»†çœ‹ï¼Œæ²¡å¿…è¦æ•´è¿™äº›æ¨¡æ¿å…ƒç¼–ç¨‹çš„å¥‡æŠ€æ·«å·§ã€‚æ²¡æƒ³åˆ°é¢è¯•æŸé‡åŒ–C</ins>å¼€å‘çš„æ—¶å€™è¢«ç‹ ç‹ æ‹·æ‰“â€¦</p></blockquote><h2 id="crtp-curiously-recurring-template-pattern"><a class="markdownIt-Anchor" href="#crtp-curiously-recurring-template-pattern"></a> CRTP (<strong>curiously recurring template pattern</strong>)</h2><p>ä¸€èˆ¬è®¤ä¸ºï¼ŒCRTPå¯ä»¥ç”¨æ¥å®ç°é™æ€å¤šæ€</p><figure class="highlight cpp"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> &#123;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">static_cast</span>&lt;T*&gt;(<span class="hljs-keyword">this</span>)-&gt;<span class="hljs-built_in">funcImpl</span>();<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base&lt;Derived&gt; &#123;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">funcImpl</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// do works here</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>é€šè¿‡CRTPå¯ä»¥ä½¿å¾—ç±»å…·æœ‰ç±»ä¼¼äºè™šå‡½æ•°çš„æ•ˆæœï¼ŒåŒæ—¶åˆæ²¡æœ‰è™šå‡½æ•°è°ƒç”¨æ—¶çš„å¼€é”€(è™šå‡½æ•°è°ƒç”¨éœ€è¦é€šè¿‡è™šå‡½æ•°æŒ‡é’ˆæŸ¥æ‰¾è™šå‡½æ•°è¡¨è¿›è¡Œè°ƒç”¨)ï¼ŒåŒæ—¶ç±»çš„å¯¹è±¡çš„ä½“ç§¯ç›¸æ¯”ä½¿ç”¨è™šå‡½æ•°ä¹Ÿä¼šå‡å°‘(ä¸éœ€è¦å­˜å‚¨è™šå‡½æ•°æŒ‡é’ˆ)ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯æ— æ³•åŠ¨æ€ç»‘å®šï¼Œæ„Ÿè§‰æœ‰ç‚¹è¿‡äºé¸¡è‚‹ã€‚</p><p>æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå¯ä»¥ç”¨æ¥å‘çº¯è™šç±»ä¸€æ ·åšæ¥å£ï¼šï¼ˆä»¥ä¸‹ç±»ä¼¼çš„ä»£ç åœ¨å¤§é‡æ•°å­¦åº“ä¸­å‡ºç°ï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> ChildType&gt; <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">VectorBase</span> &#123;<br>  <span class="hljs-function">ChildType &amp;<span class="hljs-title">underlying</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;ChildType &amp;&gt;(*<span class="hljs-keyword">this</span>); &#125;<br>  <span class="hljs-keyword">inline</span> ChildType &amp;<span class="hljs-keyword">operator</span>+=(<span class="hljs-type">const</span> ChildType &amp;rhs) &#123;<br>    <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">underlying</span>() = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">underlying</span>() + rhs;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">underlying</span>();<br>  &#125;<br>&#125;;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Vec3f</span> : <span class="hljs-keyword">public</span> VectorBase&lt;Vec3f&gt; &#123;<br>  <span class="hljs-type">float</span> x&#123;&#125;, y&#123;&#125;, z&#123;&#125;;<br>  <span class="hljs-built_in">Vec3f</span>() = <span class="hljs-keyword">default</span>;<br>  <span class="hljs-built_in">Vec3f</span>(<span class="hljs-type">float</span> x, <span class="hljs-type">float</span> y, <span class="hljs-type">float</span> z) : <span class="hljs-built_in">x</span>(x), <span class="hljs-built_in">y</span>(y), <span class="hljs-built_in">z</span>(z) &#123;&#125;<br>&#125;;<br><br><span class="hljs-keyword">inline</span> Vec3f <span class="hljs-keyword">operator</span>+(<span class="hljs-type">const</span> Vec3f &amp;lhs, <span class="hljs-type">const</span> Vec3f &amp;rhs) &#123;<br>  Vec3f result;<br>  result.x = lhs.x + rhs.x;<br>  result.y = lhs.y + rhs.y;<br>  result.z = lhs.z + rhs.z;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®šä¹‰å¥½VectorBaseåï¼ŒVec3f, Vec4fç­‰ç›´æ¥å®ç°æ¥å£å°±å¥½ã€‚ç›¸æ¯”è™šå‡½æ•°çš„å½¢å¼ï¼Œåœ¨ç©ºé—´å’Œruntimeéƒ½æœ‰ä¼˜åŠ¿ã€‚</p><h3 id="enable_shared_from_this"><a class="markdownIt-Anchor" href="#enable_shared_from_this"></a> enable_shared_from_this ?</h3><p>å¦ä¸€ä¸ªå¸¸è§çš„ç”¨å¤„æ˜¯ä¸ <code>shared_ptr</code>é…å¥—çš„ <code>std::enable_shared_from_this</code>ã€‚è‹¥æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨shared_ptrç®¡ç†çš„èµ„æºï¼Œå½“æˆ‘ä»¬æƒ³è¦æ¥ç®¡è¯¥èµ„æºï¼Œè¿”å›ä¸€ä¸ªæ¥ç®¡ <code>this</code>çš„ <code>shared_ptr</code>æ—¶</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// buggy</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Bad</span> &#123;<br>  <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> -&gt; shared_ptr&lt;Bad&gt; </span>&#123;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">shared_ptr</span>&lt;Bad&gt;(<span class="hljs-keyword">this</span>);<br>  &#125;<br>&#125;;<br><br><span class="hljs-built_in">TEST</span>() &#123;<br>  <span class="hljs-keyword">auto</span> p1 = std::<span class="hljs-built_in">make_shared</span>&lt;Bad&gt;();<br>  <span class="hljs-keyword">auto</span> p2 = p1-&gt;<span class="hljs-built_in">get</span>();<br>  <span class="hljs-built_in">assert</span>(p2.<span class="hljs-built_in">use_cont</span>() == <span class="hljs-number">1</span>);  <span class="hljs-comment">// Unexpected!</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç é”™è¯¯çš„åŸå› åœ¨äº<strong>std::make_sharedæ€»æ˜¯åˆ›å»ºä¸€ä¸ªæ§åˆ¶å—</strong>ï¼Œä»è€Œå¯¼è‡´p1, p2è™½ç„¶ç®¡ç†çš„å¯¹è±¡ç›¸åŒï¼Œå´å¹¶ä¸çŸ¥é“å½¼æ­¤çš„å­˜åœ¨ã€‚ä¸¤è€…çš„ <code>ref-cnt</code>éƒ½æ˜¯1ï¼Œåœ¨ææ„çš„æ—¶å€™è¯¥å¯¹è±¡ä¼šè¢«ææ„ä¸¤æ¬¡ã€‚ç±»ä¼¼çš„bugè¿˜æœ‰ <em>effective modern c++ Item19</em> ä¸­çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::vector&lt;std::shared_ptr&lt;Widge&gt;&gt; processedWidgets;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Widget</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  ...<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> </span>&#123;<br>    ...  <span class="hljs-comment">// process</span><br>    processedWidgets.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-keyword">this</span>);  <span class="hljs-comment">// buggy!</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ­£ç¡®çš„åšæ³•æ˜¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Widget</span>: <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Widget&gt; &#123;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> </span>&#123;<br>    ...  <span class="hljs-comment">// process</span><br>    processedWidgets.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">shared_from_this</span>());<br>  &#125;<br>&#125;;<br><br></code></pre></td></tr></table></figure><p>è€Œè¿™é‡Œçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯CRTPã€‚å®ç°å¤§æ¦‚å°±æ˜¯å€Ÿç”¨ä¸€ä¸ª <code>weak_ptr</code>ï¼Œåœ¨std::shared_from_thisæ—¶å€™åˆ©ç”¨è¿™ä¸ªweak_ptrè¿›è¡Œæ–°çš„shared_ptrçš„æ‹·è´æ„é€ ï¼Œä»è€Œå¢åŠ å¼•ç”¨è®¡æ•°ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>C++ idioms</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è½»é‡çº§é«˜å¹¶å‘ç½‘ç»œåº“+httpserver</title>
    <link href="/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%BD%91%E7%BB%9C%E5%BA%93-httpserver/"/>
    <url>/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%BD%91%E7%BB%9C%E5%BA%93-httpserver/</url>
    
    <content type="html"><![CDATA[<img src="../img/FalconLink/falcon-black.png" width="100%" height="75%"><blockquote><p>æœ¬åšå®¢éƒ¨ç½²åœ¨ä¸¤ä¸ªæœåŠ¡å™¨ä¸Šï¼Œå…¶ä¸­ä¸€ä¸ªçš„ HTTP æœåŠ¡å°±æ˜¯ç”±æœ¬æ–‡ä»‹ç»çš„ FalconLink æä¾›ã€‚ä½ å¯ä»¥é€šè¿‡IPåœ°å€ 121.4.49.170:20080 å°è¯•è®¿é—®ã€‚ é¡¹ç›®åœ°å€ <a href="https://github.com/caaatch22/FalconLink">https://github.com/caaatch22/FalconLink</a></p></blockquote><h2 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> Overview</h2><p><strong>FalconLink</strong>æ˜¯ä¸€ä¸ªè½»é‡çº§çš„é«˜å¹¶å‘ç½‘ç»œåº“ã€‚å®ƒå°è£…äº†ç½‘ç»œç¼–ç¨‹å¥—æ¥å­—APIï¼Œå°†å…¶æŠ½è±¡æˆä¸€ä¸ªæ˜“ç”¨ï¼Œå¯æ‹“å±•æ¡†æ¶ã€‚ç”¨æˆ·åªéœ€é€šè¿‡è®¾ç½®å›è°ƒå‡½æ•°çš„å½¢å¼æ³¨å…¥ä¸šåŠ¡é€»è¾‘ã€‚å®ƒåŒæ—¶ä¹Ÿå…·æœ‰ HTTP æœåŠ¡è¯·æ±‚ä¸è§£æçš„åŠŸèƒ½ã€‚</p><p><img src="../img/FalconLink/falconlink-architecture.png" alt="" /></p><p>ä¸Šå›¾æ˜¯FalconLinkç³»ç»Ÿæ¶æ„çš„ä¸€ä¸ªç®€å•æ¦‚æ‹¬æ€§å›¾ç¤ºã€‚</p><ul><li>é‡‡ç”¨<strong>éé˜»å¡socket</strong>é…åˆ<strong>è¾¹ç¼˜è§¦å‘</strong>ï¼ŒåŠ<em>one loop per thread</em>çš„ä¸»ä» <code>reactor</code>è®¾è®¡</li><li><code>Acceptor</code> æ˜¯ä¸“é—¨ç”¨äºå¤„ç†æ¥å—æ–°ç”¨æˆ·è¿æ¥è¯·æ±‚çš„æ¨¡å—ã€‚å®ƒå®ˆå€™åœ¨ç›‘å¬ç«¯å£ã€‚æ”¶åˆ°è¯·æ±‚åå»ºç«‹ <code>Connection</code> åˆ†é…ç»™ EventLoopã€‚</li><li>FalconLink å°†æ¯ä¸ª TCPè¿æ¥æŠ½è±¡æˆä¸€ä¸ª <code>Connection</code>ï¼Œä¸€ä¸ª <code>Connection</code>å¯¹åº”ä¸€ä¸ªè¿æ¥ socket å¥—æ¥å­—ã€‚ç”¨æˆ·å¯ä»¥ä¸ºæ¯ä¸€æ¡Connectionæ³¨å†Œå›è°ƒå‡½æ•°ã€‚</li><li>æ¯ä¸ª <code>EventLoop</code> éƒ½æ‹¥æœ‰ä¸€ä¸ª <code>Poller</code>ã€‚ <code>Poller</code> è´Ÿè´£ç›‘å¬å·²è¿æ¥çš„å¥—æ¥å­—ï¼Œå°†æœ‰äº‹ä»¶è§¦å‘çš„è¿æ¥åé¦ˆç»™ <code>EventLoop</code>ã€‚</li><li><code>EventLoop</code>æ˜¯è¯¥ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶, æ¯ä¸ªéƒ½å•ç‹¬è¿è¡Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­. å®ƒä» <code>Poller</code> ä¸­æ¥æ”¶åˆ°æœ‰äº‹ä»¶è§¦å‘çš„ç”¨æˆ·è¿æ¥å, ä¼šè·å–å¹¶æ‰§è¡Œå®ƒä»¬çš„å›è°ƒå‡½æ•°.</li><li><code>ThreadPool</code> çº¿ç¨‹æ± ç®¡ç†ç€ç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ª <code>EventLoop</code> åœ¨è¿è¡Œï¼Œå¹¶è°ƒåº¦çº¿ç¨‹ï¼Œé˜²æ­¢æ³¨å†Œè¿‡å¤šçº¿ç¨‹å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li><li>æ”¯æŒ HTTP(GET,HEAD)è¯·æ±‚çš„è§£æä¸å›å¤ï¼Œæ”¯æŒæŒ‚è½½é™æ€ html æ–‡ä»¶ï¼ˆæœ¬åšå®¢ä½¿ç”¨FalconLinkçš„ HTTP æœåŠ¡ï¼‰</li><li>å®ç°å¼‚æ­¥logger</li></ul><h2 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h2><p>ä½¿ç”¨falconlinkï¼Œå¯ä»¥è½»æ˜“ä¸”ä¼˜é›…çš„åœ¨20è¡Œå†…å®ç°ä¸€ä¸ª <code>echo server</code>ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;falconlink.hpp&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-function">falconlink::InetAddr <span class="hljs-title">local_address</span><span class="hljs-params">(<span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-number">8090</span>)</span></span>;<br>  <span class="hljs-function">falconlink::Server <span class="hljs-title">echo_server</span><span class="hljs-params">(local_address)</span></span>;<br>  echo_server<br>      .<span class="hljs-built_in">onHandle</span>([&amp;](falconlink::Connection* client_conn) &#123;<br>        <span class="hljs-type">int</span> from_fd = client_conn-&gt;<span class="hljs-built_in">fd</span>();<br>        <span class="hljs-keyword">auto</span> [read, exit] = client_conn-&gt;<span class="hljs-built_in">recv</span>();<br>        <span class="hljs-keyword">if</span> (exit) &#123;<br>          client_conn-&gt;<span class="hljs-built_in">getEventLoop</span>()-&gt;<span class="hljs-built_in">deleteConnection</span>(from_fd);<br>          <span class="hljs-comment">// client_conn ptr is invalid below here, do not touch it again</span><br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// åªæœ‰ä»¥ä¸‹å››è¡Œæ˜¯ä¸šåŠ¡é€»è¾‘</span><br>        <span class="hljs-keyword">if</span> (read) &#123;<br>          client_conn-&gt;<span class="hljs-built_in">WriteToWriteBuffer</span>(client_conn-&gt;<span class="hljs-built_in">ReadAsString</span>());<br>          client_conn-&gt;<span class="hljs-built_in">send</span>();<br>          client_conn-&gt;<span class="hljs-built_in">clearReadBuffer</span>();<br>        &#125;<br>      <br>      &#125;)<br>      .<span class="hljs-built_in">start</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="build-test"><a class="markdownIt-Anchor" href="#build-test"></a> Build &amp; Test</h2><p>å°†ä»£ç  clone åˆ°æœ¬åœ°ï¼Œè¿›å…¥ä¸»ç›®å½•</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo sh ./build_support/pachages.sh<br><br><span class="hljs-built_in">mkdir</span> build<br><span class="hljs-built_in">cd</span> build<br><br>cmake ..  <span class="hljs-comment"># Debug mode by default</span><br><span class="hljs-comment"># or </span><br>cmake -DCMAKE_BUILD_TYPE=Release .. <span class="hljs-comment"># to use release mode</span><br><br>make<br><br><span class="hljs-comment"># test</span><br>make build-tests<br>make <span class="hljs-built_in">test</span><br><br><span class="hljs-comment"># or you can test each file</span><br>make xxx_test<br>./test/xxx_test<br><br></code></pre></td></tr></table></figure><h2 id="http-service"><a class="markdownIt-Anchor" href="#http-service"></a> http service</h2><p>ä½ å¯ä»¥è¿›è¡Œä½¿ç”¨ falconlink æ­å»ºè‡ªå·±çš„ http æœåŠ¡å™¨ã€‚<br />åœ¨ <code>build</code> ç›®å½•ä¸‹ <code>make http_server</code>ï¼Œç„¶åè¿è¡Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">./bin/http_server [optional: port default=8090] [optional:directory <br>default=../examples/http_server/http_resource/]<br></code></pre></td></tr></table></figure><p>ä½ å¯ä»¥æ›¿æ¢è‡ªè¡Œ <code>http_resource</code>ä¸­çš„æ–‡ä»¶ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ <code>localhost:&#123;port&#125;</code>æŸ¥çœ‹</p><h2 id="benchmark"><a class="markdownIt-Anchor" href="#benchmark"></a> Benchmark</h2><p>ä½¿ç”¨ <code>webbench</code>è¿›è¡Œå‹åŠ›æµ‹è¯•</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">make benchmark<br></code></pre></td></tr></table></figure><ul><li><p><strong>ç¡¬ä»¶</strong>:</p><ul><li>IntelÂ® XeonÂ® Gold 6148 CPU @ 2.40GHz</li><li>OS:Ubuntu 20.04 LTS,</li><li>4 æ ¸ CPUï¼Œ 16GiBå†…å­˜ï¼Œ 100GiBç£ç›˜å­˜å‚¨ã€‚</li></ul></li><li><p><strong>QPS</strong>: <strong>40K</strong></p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>ComputerNetwork</tag>
      
      <tag>FalconLink</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CMU15445-project3 Query Excution</title>
    <link href="/CMU15445-project3-Query-Execution/"/>
    <url>/CMU15445-project3-Query-Execution/</url>
    
    <content type="html"><![CDATA[<h2 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> Overview</h2><blockquote><p>åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†<a href="https://15445.courses.cs.cmu.edu/fall2022/bustub/">æµè§ˆå™¨ä¸Šçš„bustub</a> ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>explain</code> æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚</p></blockquote><p>è¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B+æ ‘ï¼‰ã€‚</p><p><img src="../img/busTub/query_excution/project-structure.png" alt="" /></p><p>ä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚</p><h3 id="parser"><a class="markdownIt-Anchor" href="#parser"></a> Parser</h3><p>sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ª<em>æŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)</em>ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚</p><h3 id="binder"><a class="markdownIt-Anchor" href="#binder"></a> Binder</h3><p>å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> table1.y, table2.x <span class="hljs-keyword">FROM</span> table1 <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.x <span class="hljs-operator">=</span> table2.y;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>SELECT</code> å’Œ <code>FROM</code> æ˜¯å…³é”®å­—ï¼Œ<code>x</code> å’Œ <code>table1</code> æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>explain</code> æ¥çœ‹çœ‹ <code>binder</code> å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"> === BINDER ===                                               <br> BoundSelec &#123;                                        <br>   table=BoundJoin &#123; type=Inner, left=BoundBaseTableRef &#123; table=table1, oid=25 &#125;, right=BoundBaseTableRef &#123; table=table2, oid=26 &#125;, condition=(table1.x=table2.y) &#125;, <br>   columns=[table1.y, table2.x],                       <br>   groupBy=[],<br>   having=,  <br>   where=,  <br>   limit=, <br>   offset=,<br>   order_by=[],                                 <br>   is_distinct=false,         <br>   ctes=,<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚</p><h3 id="planner"><a class="markdownIt-Anchor" href="#planner"></a> Planner</h3><p>å¾—åˆ° Bustub AST åï¼ŒPlanner éå†è¿™æ£µæ ‘ï¼Œç”Ÿæˆåˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’ã€‚æŸ¥è¯¢è®¡åˆ’ä¹Ÿæ˜¯ä¸€æ£µæ ‘çš„å½¢å¼ã€‚ä¾‹å¦‚è¿™æ¡ sqlï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> table1.y, table2.x <span class="hljs-keyword">FROM</span> table1 <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> t1.x <span class="hljs-operator">=</span> t2.y;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ explainï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">=== PLANNER ===<br>Projection &#123; exprs=[#0.1, #0.2] &#125; | (table1.y:INTEGER, table2.x:INTEGER)                                                                                            <br>  NestedLoopJoin &#123; type=Inner, predicate=(#0.0=#1.1) &#125; | (table1.x:INTEGER, table1.y:INTEGER, table2.x:INTEGER, table2.y:INTEGER)                                   <br>    SeqScan &#123; table=table1 &#125; | (table1.x:INTEGER, table1.y:INTEGER)                                                                                                 <br>    SeqScan &#123; table=table2 &#125; | (table2.x:INTEGER, table2.y:INTEGER) <br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„è§£é‡Šå…¶å®æ˜¯æ ‘å‹çš„ï¼Œå¦‚ä¸‹å›¾ï¼š<br /><img src="../img/busTub/query_excution/planner-tree.png" alt="" /><br />æŸ¥è¯¢è®¡åˆ’è§„å®šäº†æ•°æ®çš„æµå‘ã€‚æ•°æ®ä»æ ‘å¶æµå‘æ ‘æ ¹ï¼Œè‡ªåº•å‘ä¸Šåœ°æµåŠ¨ï¼Œåœ¨æ ¹èŠ‚ç‚¹è¾“å‡ºç»“æœã€‚</p><h3 id="optimizer"><a class="markdownIt-Anchor" href="#optimizer"></a> Optimizer</h3><p>ç”ŸæˆæŸ¥è¯¢è®¡åˆ’å<br />ç”± Planner å¾—åˆ°åˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå†å°†æŸ¥è¯¢è®¡åˆ’äº¤ç»™ Optimizer è¿›è¡Œä¿®æ”¹ä¼˜åŒ–ï¼Œç”Ÿæˆä¼˜åŒ–è¿‡åçš„æœ€ç»ˆæŸ¥è¯¢è®¡åˆ’ã€‚Optimizer ä¸»è¦æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p><ul><li>Rule-based.<ul><li>é€šè¿‡è‡ªåŠ¨é‡å†™æŸ¥è¯¢æ¥é¿å…æ•ˆç‡ä½çš„æ–¹æ³•ã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨ Task 3 ä¸­å°†è¦å®ç°çš„ï¼Œå°† <code>Limit + Sort</code> åˆå¹¶ä¸º <code>TopN</code>ã€‚</li><li>è¿™ç§ Optimizer ä¸éœ€è¦çŸ¥é“æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œä»…æ˜¯æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„è§„åˆ™ä¿®æ”¹ <code>Plan Node</code>ã€‚</li></ul></li><li>Cost-based.<ul><li>ç”¨æŸç§æ¨¡å‹æ¥é¢„ä¼°æ‰§è¡Œè®¡åˆ’çš„æ—¶é—´ï¼Œè¿™å°±éœ€è¦å­˜å¾ˆå¤šè·Ÿæ•°æ®ç›¸å…³çš„æ•°æ®</li><li>é€šè¿‡å¯¹ä¸åŒæ¨¡å‹çš„ cost æ¯”è¾ƒé€‰å‡ºæ‰§è¡Œ cost æœ€å°çš„ã€‚</li><li>è¿™ä¹Ÿä¼šé€ æˆä¸€äº›é¢å¤–å¼€é”€ ï¼ˆè¿è¡Œè¿™ä¸ªcost modelï¼‰</li></ul></li></ul><p>Bustub çš„ Optimizer é‡‡ç”¨ç¬¬ä¸€ç§å®ç°æ–¹å¼ã€‚</p><blockquote><p>ä¸€èˆ¬æ¥è¯´ï¼ŒPlanner ç”Ÿæˆçš„æ˜¯ Logical Plan Nodeï¼Œä»£è¡¨æŠ½è±¡çš„ Planã€‚Optimizer åˆ™ç”Ÿæˆ Physical Plan Nodeï¼Œä»£è¡¨å…·ä½“æ‰§è¡Œçš„ Planã€‚ä¾‹å¦‚æ˜¯ Joinã€‚åœ¨ Planner ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin å°±æ˜¯ Joinã€‚åœ¨ Optimizer ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin ä¼šè¢«ä¼˜åŒ–æˆå…·ä½“çš„ HashJoin æˆ– NestedIndexJoin ç­‰ç­‰ã€‚åœ¨ Bustub ä¸­ï¼Œå¹¶ä¸åŒºåˆ† Logical Plan Node å’Œ Physical Plan Nodeã€‚Planner ä¼šç›´æ¥ç”Ÿæˆ Physical Plan Nodeã€‚</p></blockquote><h3 id="executor"><a class="markdownIt-Anchor" href="#executor"></a> Executor</h3><p>åœ¨æ‹¿åˆ° Optimizer ç”Ÿæˆçš„å…·ä½“çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå°±å¯ä»¥ç”ŸæˆçœŸæ­£æ‰§è¡ŒæŸ¥è¯¢è®¡åˆ’çš„ä¸€ç³»åˆ—ç®—å­äº†ã€‚ç®—å­ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ Project 3 ä¸­éœ€è¦å®ç°çš„ä¸»è¦å†…å®¹ã€‚ç”Ÿæˆç®—å­çš„æ­¥éª¤å¾ˆç®€å•ï¼Œéå†æŸ¥è¯¢è®¡åˆ’æ ‘ï¼Œå°†æ ‘ä¸Šçš„ PlanNode æ›¿æ¢æˆå¯¹åº”çš„ Executorã€‚ç®—å­çš„æ‰§è¡Œæ¨¡å‹ä¹Ÿå¤§è‡´åˆ†ä¸ºä¸‰ç§ï¼š</p><ol><li><p>Iterator/Pipeline Model(volcano model)ã€‚æ¯ä¸ªç®—å­éƒ½æœ‰ Init() å’Œ Next() ä¸¤ä¸ªæ–¹æ³•ã€‚Init() å¯¹ç®—å­è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚Next() åˆ™æ˜¯å‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ã€‚å½“ Next() è¿”å› false æ—¶ï¼Œåˆ™ä»£è¡¨ä¸‹å±‚ç®—å­å·²ç»æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œè¿­ä»£ç»“æŸã€‚ç«å±±æ¨¡å‹ä¸€æ¬¡è°ƒç”¨åªå‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸€æ¡æ•°æ®ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œä½†å‡½æ•°è°ƒç”¨å¼€é”€å¤§ã€‚ <img src="../img/busTub/query_excution/iterator-model.png" alt="" /></p></li><li><p>Materialization Model. æ‰€æœ‰ç®—å­ç«‹å³è®¡ç®—å‡ºæ‰€æœ‰ç»“æœå¹¶è¿”å›ã€‚å’Œ Iterator Model ç›¸åã€‚è¿™ç§æ¨¡å‹çš„å¼Šç«¯æ˜¾è€Œæ˜“è§ï¼Œå½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå†…å­˜å ç”¨å¾ˆé«˜ï¼Œä½†å‡å°‘äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚æ¯”è¾ƒé€‚åˆæŸ¥è¯¢æ•°æ®é‡è¾ƒå°çš„ OLTP workloadsã€‚</p></li><li><p>Vectorized/Batch Model. å¯¹ä¸Šé¢ä¸¤ç§æ¨¡å‹çš„ä¸­å’Œï¼Œä¸€æ¬¡è°ƒç”¨è¿”å›ä¸€æ‰¹æ•°æ®ã€‚åˆ©äº SIMD åŠ é€Ÿã€‚ç›®å‰æ¯”è¾ƒå…ˆè¿›çš„ OLAP æ•°æ®åº“é‡‡ç”¨è¿™ç§æ¨¡å‹ã€‚</p></li></ol><p>Bustub é‡‡ç”¨ Iterator Modelã€‚</p><h2 id="metadata"><a class="markdownIt-Anchor" href="#metadata"></a> Metadata</h2><p>ä¸Šé¢ä»‹ç»äº† sqlè¯­å¥æ‰§è¡Œè¿‡ç¨‹ï¼Œè¶³ä»¥è®©æˆ‘ä»¬å¯¹æ•´ä¸ªæ‰§è¡Œå¼•æ“æœ‰å¤§ä½“äº†è§£ã€‚ä½†æ˜¯æˆ‘åœ¨åšè¿™ä¸ª lab æ—¶å€™è¿˜æ˜¯æœ‰å¾ˆå¤šå›°æƒ‘çš„åœ°æ–¹ã€‚æœ€åæ˜¯è¿·è¿·ç³Šç³Šçš„å†™å®Œäº†æ‰æ•´ç†äº†ä¸‹ã€‚å¤§ä½“ä¸Šçš„ä¿¡æ¯åŒ…æ‹¬åœ¨ä¸‹å›¾ä¸­ï¼š<br /><img src="../img/busTub/query_excution/table-matedata.png" alt="" /><br />ï¼ˆå›¾ç‰‡æ”¹è‡ª<a href="https://blog.eleven.wiki/posts/cmu15-445-project3-query-execution/">è¿™ç¯‡åšå®¢</a>ï¼‰</p><h2 id="task-1-access-method-executors"><a class="markdownIt-Anchor" href="#task-1-access-method-executors"></a> Task #1 - Access Method Executors</h2><h3 id="seqscan"><a class="markdownIt-Anchor" href="#seqscan"></a> SeqScan</h3><p>å®ç°æ¯”è¾ƒç®€å•ï¼Œè·å– table_iter ç›´æ¥éå†å³å¯ã€‚è¿™é‡Œè¯´è¯´è¿™ä¸ª<code>plan_-&gt;filter_predicate_</code>ï¼Œ ä»–æ˜¯ä¸€ä¸ª<code>AbstractExpressionRef</code>ï¼Œè€Œä¸€ä¸ª<code>AbstractExpression</code>æ„æ€æ˜¯ä¸€ä¸ª <em>è¡¨è¾¾å¼</em> ï¼Œä»–é‡Œé¢æœ€é‡è¦çš„ä¸¤ä¸ªå‡½æ•°æ˜¯ <code>Evaluate(const Tuple *tuple, const Schema &amp;schema)</code>å’Œ <code>EvaluateJoin(const Tuple *left_tuple, const Schema &amp;left_schema, const Tuple *right_tuple, const Schema &amp;right_schema)</code>ï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥åš filter çš„ã€‚ä¾‹å¦‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> x <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>å¦‚æœä»»ä½•ä¼˜åŒ–éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆä¸Šè¿°è¯­å¥å¯ä»¥è§£æä¸ºä¸¤å±‚ï¼š</p><ol><li>ä» table1 ä¸­é€‰å‡ºæ‰€æœ‰çš„ tupleã€‚</li><li>é€‰å‡º x = 1çš„ tupleã€‚ç›¸å½“äºåº•ä¸‹çš„ seqscan ç»“ç‚¹ä¼šå°†æ‰€æœ‰ tuple å‘åˆ°ä¸Šä¸€å±‚ï¼Œç„¶åä¸Šä¸€å±‚å†åšä¸€æ¬¡ filterã€‚ä½†æ˜¯æˆ‘ä»¬é€šè¿‡è°“è¯ä¸‹æ¨ï¼Œå¯ä»¥åœ¨seqscan æ—¶å€™å°±é€šè¿‡ filter_predicate_ å°†éœ€è¦çš„è¿‡æ»¤å‡ºæ¥ï¼Œä¸éœ€è¦çš„ä¸ç”¨å‘ç»™ä¸Šä¸€å±‚ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ªä¾‹å­ä¸å¤ªå‡†ç¡®ã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹æœ¬æ¥å°±æ˜¯ä¸€æ¬¡æå®šçš„ï¼Œæ€»ä¹‹æ˜¯åœ¨å¤æ‚çš„æ—¶å€™å¯ä»¥æŠŠè°“è¯ä¸‹æ¨ï¼‰ã€‚<br />è¿™ä¸ª Evaluate è¿”å›ä¸€ä¸ª <code>Value</code>ï¼Œå®é™…ä¸Šå¦‚æœåšfilteråº”è¯¥è¿”å› booleanï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡<code>filter_predicate_-&gt;Evaluate(tuple, table_info_-&gt;schema_).GetAs&lt;bool&gt;()</code>è½¬åŒ–ä¸€ä¸‹ã€‚<br />å¦å¤–ï¼Œseqscan å®é™…ä¸Šä¸ä¼šç”¨åˆ° filter_predicateã€‚åé¢é‡åˆ°éœ€è¦ predicate çš„åœ°æ–¹ä¼šå†å¼ºè°ƒã€‚</li></ol><h3 id="insert-delete"><a class="markdownIt-Anchor" href="#insert-delete"></a> Insert &amp; Delete</h3><p>è¿™ä¸¤ä¸ªç®—å­æ˜¯å”¯äºŒçš„å†™ç®—å­ï¼ˆå®é™…ä¸Šåé¢çš„ä¼˜åŒ–è¿‡ç¨‹ä¸­éœ€è¦å®ç°ä¸€ä¸ª updateç®—å­ï¼‰ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™ä¸¤ä¸ªç®—å­çš„è¡Œä¸ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">bustub<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t1 <span class="hljs-keyword">values</span> (<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;ğŸ¥°&#x27;</span>, <span class="hljs-number">10</span>), (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;ğŸ¥°ğŸ¥°&#x27;</span>, <span class="hljs-number">11</span>), (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;ğŸ¥°ğŸ¥°ğŸ¥°&#x27;</span>, <span class="hljs-number">12</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°&#x27;</span>, <span class="hljs-number">13</span>), (<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°&#x27;</span>, <span class="hljs-number">14</span>);<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> output<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span> __bustub_internal.insert_rows <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-number">5</span>                             <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªç®—å­ä»–ä»¬ä¼šä¸€ç›´ nextï¼Œç„¶åè¿”å›ä¸€æ¬¡ï¼Œè¿”å›çš„æ˜¯æ’å…¥/åˆ é™¤ tuple çš„ä¸ªæ•°ï¼ˆæ‰€ç”Ÿæˆçš„tupleï¼‰ã€‚æœ‰ç‚¹åƒ <code>pipeline breaker</code>ï¼Œä½†æ˜¯ç”±äºä»–ä»¬ä¸€å®šæ˜¯é¡¶å±‚ç®—å­ï¼Œæ‰€ä»¥å¥½åƒä¸å« <code>pipeline breaker</code>ã€‚</p><p>ä¸ªäººæ„Ÿè§‰è¿™ä¸ªè¿”å›ä¸ªæ•°çš„è®¾è®¡æœ‰ç‚¹ä¸æ˜¯å¾ˆåˆç†ï¼Œå®ƒä¸€å®šè¦å°†ä¸ªæ•°è½¬åŒ–æˆä¸€ä¸ªtupleè¿”å›ã€‚å¤§æ¦‚æ˜¯è¿™æ ·çš„æ“ä½œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">*tuple =<br>    <span class="hljs-built_in">Tuple</span>(std::<span class="hljs-built_in">vector</span>&lt;Value&gt;(<span class="hljs-built_in">GetOutputSchema</span>().<span class="hljs-built_in">GetColumnCount</span>() <span class="hljs-comment">/* ColumnCount() should be one*/</span>, <span class="hljs-built_in">Value</span>(TypeId::INTEGER, counter)),<br>          &amp;<span class="hljs-built_in">GetOutputSchema</span>());<br></code></pre></td></tr></table></figure><p>å¦å¤–éœ€è¦æ³¨æ„çš„å°±æ˜¯è¿™äº› å¢åŠ /åˆ é™¤ tuple æ—¶ï¼Œå¯¹åº”çš„ç´¢å¼•é¡¹ä¹Ÿéœ€è¦å¢åŠ /åˆ é™¤ã€‚</p><h3 id="indexscan"><a class="markdownIt-Anchor" href="#indexscan"></a> IndexScan</h3><p>è¿™ä¸ªå°±ç®€å•äº†ï¼Œåœ¨ Init() æ—¶å€™ä¿å­˜ index_iterï¼Œ next() æ—¶ç›´æ¥è°ƒç”¨å†è‡ªå¢å°±å¯ä»¥ã€‚</p><h2 id="task-2-aggregation-join-executors"><a class="markdownIt-Anchor" href="#task-2-aggregation-join-executors"></a> Task #2 - Aggregation &amp; Join Executors</h2><h3 id="aggregation"><a class="markdownIt-Anchor" href="#aggregation"></a> Aggregation</h3><p>aggregation æ“ä½œæ˜¯ä¸€ä¸ª <code>pipeline breaker</code>ã€‚ä»–ä¼šåœ¨ init å¾—åˆ°å…¨éƒ¨ç­”æ¡ˆç„¶åå† next æ—¶ä¸€æ¡ä¸€æ¡è¿”å›ã€‚</p><p><code>SimpleAggregationHashTable</code> ç»´æŠ¤ä¸€å¼ å“ˆå¸Œè¡¨ï¼Œé”®ä¸º <code>AggregateKey</code>ï¼Œå€¼ä¸º <code>AggregateValue</code>ï¼Œå‡ä¸º <code>std::vector&lt;Value&gt;</code>ã€‚key ä»£è¡¨ group by çš„å­—æ®µçš„æ•°ç»„ï¼Œvalue åˆ™æ˜¯éœ€è¦ aggregate çš„å­—æ®µçš„æ•°ç»„ã€‚åœ¨ä¸‹å±‚ç®—å­ä¼ æ¥ä¸€ä¸ª tuple æ—¶ï¼Œå°† tuple çš„ group by å­—æ®µå’Œ aggregate å­—æ®µåˆ†åˆ«æå–å‡ºæ¥ï¼Œè°ƒç”¨ <code>InsertCombine()</code> å°† group by å’Œ aggregate çš„æ˜ å°„å…³ç³»å­˜å…¥ <code>SimpleAggregationHashTable</code>ã€‚è‹¥å½“å‰ hashmap ä¸­æ²¡æœ‰ group by çš„è®°å½•ï¼Œåˆ™åˆ›å»ºåˆå€¼ï¼›è‹¥å·²æœ‰è®°å½•ï¼Œåˆ™æŒ‰ aggregate è§„åˆ™é€ä¸€æ›´æ–°æ‰€æœ‰çš„ aggregate å­—æ®µï¼Œä¾‹å¦‚å– max/minï¼Œæ±‚ sum ç­‰ç­‰ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ¡ sqlï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">min</span>(t.z), <span class="hljs-built_in">max</span>(t.z), <span class="hljs-built_in">sum</span>(t.z) <span class="hljs-keyword">FROM</span> t <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> t.x, t.y;<br></code></pre></td></tr></table></figure><p>group byï¼ˆAggregateKeyï¼‰ä¸º {t.x, t.y}ï¼Œaggregateï¼ˆAggregateValueï¼‰ä¸º {t.z, t.z, t.z}ã€‚aggregate è§„åˆ™ä¸º {min, max, sum}ã€‚</p><p>éœ€è¦é¢å¤–æ³¨æ„ <code>count(column)</code> å’Œ <code>count(*)</code> çš„åŒºåˆ«ï¼Œä»¥åŠå¯¹ç©ºå€¼çš„å¤„ç†ã€‚</p><p>åœ¨ Init() ä¸­è®¡ç®—å‡ºæ•´å¼  hashmap åï¼Œåœ¨ Next() ä¸­ç›´æ¥åˆ©ç”¨ hashmap iterator å°†ç»“æœä¾æ¬¡å–å‡ºã€‚è¿™é‡Œçš„è¾“å‡ºå½¢å¼æœ‰ç‚¹å¥‡æ€ªï¼Œéœ€è¦è¿™æ ·çš„è¾“å‡ºï¼š<br /><img src="../img/busTub/query_excution/aggregate-return.png" alt="" /></p><p><code>schema</code> å·²ç»åœ¨ <code>GetOutputSchema()</code> ä¸­å‡†å¤‡å¥½äº†ã€‚</p><h3 id="nestedloopjoin"><a class="markdownIt-Anchor" href="#nestedloopjoin"></a> NestedLoopJoin</h3><p>æˆ‘çš„å®ç°æ¯”è¾ƒ trickyã€‚æˆ‘åœ¨ init æ—¶å€™ç›´æ¥æŠŠä¸‹å±‚ç®—å­ï¼ˆleft_executorå’Œright_executorï¼‰æ‰€æœ‰çš„tupleéƒ½å¾—åˆ°äº†ï¼ˆç›¸å½“äºå½“ä½œ pipeline breakerï¼‰ï¼Œä¿å­˜åœ¨ä¸¤å¼ è¡¨ä¸­ã€‚å† nextæ—¶å€™è¿›è¡ŒåŒ¹é…ã€‚è¿™é‡Œçš„ left-join å’Œ inner-join æ˜¯éœ€è¦åˆ†å¼€å®ç°çš„ï¼Œå¯ä»¥åœ¨ç½‘ä¸ŠæŸ¥ä¸‹left-joinå’Œinner-joinçš„åŒºåˆ«ã€‚<br />åœ¨è¿™é‡Œåˆ¤æ–­å·¦å³ä¸¤ä¸ª tuple æ˜¯å¦ match å°±éœ€è¦ç”¨åˆ°<code>plan_-&gt;Predicate().EvaluateJoin()</code>ï¼ŒåŒæ ·è¦ <code>GetAs&lt;bool&gt;()</code>ã€‚</p><p>å½“æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª match åï¼Œè¿”å›å‰è®°å¾—<strong>ä¿å­˜ä¸Šä¸‹æ–‡</strong>ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥ä¿å­˜ match çš„ tuple å†å·¦è¡¨ä¸­çš„ä¸‹æ ‡å’Œå³è¡¨ä¸­çš„ä¸‹æ ‡ï¼Œè¿™æ ·ä¸‹æ¬¡è°ƒç”¨ next æ—¶å€™ï¼Œå°±ä¸ç”¨é‡æ–°æ‰«æä¸€æ¬¡ã€‚</p><h3 id="nestedindexjoin"><a class="markdownIt-Anchor" href="#nestedindexjoin"></a> NestedIndexJoin</h3><p>åœ¨è¿›è¡Œ equi-join æ—¶ï¼Œå¦‚æœå‘ç° JOIN ON å³è¾¹çš„å­—æ®µä¸Šå»ºäº† indexï¼Œåˆ™ Optimizer ä¼šå°† NestedLoopJoin ä¼˜åŒ–ä¸º NestedIndexJoinã€‚å…·ä½“å®ç°å’Œ NestedLoopJoin å·®ä¸å¤šï¼Œåªæ˜¯åœ¨å°è¯•åŒ¹é…å³è¡¨ tuple æ—¶ï¼Œä¼šæ‹¿ join key å» B+Tree Index é‡Œè¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢åˆ°ç»“æœï¼Œå°±æ‹¿ç€æŸ¥åˆ°çš„ RID å»å³è¡¨è·å– tuple ç„¶åè£…é…æˆç»“æœè¾“å‡ºã€‚</p><h2 id="task-3-sort-limit-executors-and-top-n-optimization"><a class="markdownIt-Anchor" href="#task-3-sort-limit-executors-and-top-n-optimization"></a> Task #3 - Sort + Limit Executors and Top-N Optimization</h2><h3 id="sort"><a class="markdownIt-Anchor" href="#sort"></a> sort</h3><p>è¿™ä¸ªå®éªŒçš„ sort æ— éœ€è¿›è¡Œå¤–éƒ¨æ’åºï¼Œé‡è½½å°äºåå°±å¯ä»¥å®ç°ã€‚å°±æ˜¯æ¯”è¾ƒçš„æ–¹å¼æœ‰ç‚¹å¥‡æ€ªï¼Œå¯ä»¥ç±»æ¯”ä»¥ä¸‹å†™ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">order_key.second-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;lhs, schema).<span class="hljs-built_in">CompareLessThan</span>(order_key.second-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;rhs, schema))<br></code></pre></td></tr></table></figure><h3 id="limit"><a class="markdownIt-Anchor" href="#limit"></a> limit</h3><p>ç®€å•ï¼Œlimit é™åˆ¶åœ¨ <code>plan_-&gt;Getlimit()</code>é‡Œé¢ã€‚</p><h3 id="top-n-optimization-rule"><a class="markdownIt-Anchor" href="#top-n-optimization-rule"></a> Top-N Optimization Rule</h3><p>ç®€å•ï¼Œä¼˜å…ˆé˜Ÿåˆ—é‡è½½å°äºï¼ˆé‡è½½æ–¹å¼ä¸ sort ç›¸åŒï¼‰ï¼Œç„¶åæˆªå–å‰ n ä¸ªã€‚</p><h3 id="sort-limit-as-topn"><a class="markdownIt-Anchor" href="#sort-limit-as-topn"></a> Sort + Limit As TopN</h3><p>è¿™æ˜¯ Project 3 é‡Œæœ€åä¸€ä¸ªå¿…åšçš„å°é—®ï¼Œä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ª Optimizer ï¼Œå°† Sort + Limit ä¼˜åŒ–ä¸º TopNã€‚å…ˆçœ‹çœ‹ Optimizer æ˜¯å¦‚ä½•æ‰§è¡Œä¼˜åŒ–è§„åˆ™çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Optimizer::OptimizeCustom</span><span class="hljs-params">(<span class="hljs-type">const</span> AbstractPlanNodeRef &amp;plan)</span> -&gt; AbstractPlanNodeRef </span>&#123;<br>  <span class="hljs-keyword">auto</span> p = plan;<br>  p = <span class="hljs-built_in">OptimizeMergeProjection</span>(p);<br>  p = <span class="hljs-built_in">OptimizeMergeFilterNLJ</span>(p);<br>  p = <span class="hljs-built_in">OptimizeNLJAsIndexJoin</span>(p);<br>  p = <span class="hljs-built_in">OptimizeNLJAsHashJoin</span>(p);  <span class="hljs-comment">// Enable this rule after you have implemented hash join.</span><br>  p = <span class="hljs-built_in">OptimizeOrderByAsIndexScan</span>(p);<br>  p = <span class="hljs-built_in">OptimizeSortLimitAsTopN</span>(p);  <span class="hljs-comment">// what we should add</span><br>  <span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè®©æœªç»ä¼˜åŒ–çš„åŸå§‹ plan æ ‘ä¾æ¬¡ç»å†å¤šæ¡è§„åˆ™ï¼Œæ¥ç”Ÿæˆä¼˜åŒ–è¿‡çš„ planã€‚æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ–°å¢ä¸€æ¡è§„åˆ™ã€‚çœ‹çœ‹å…¶ä»–è§„åˆ™æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¾‹å¦‚ NLJAsIndexJoinï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Optimizer::OptimizeNLJAsIndexJoin</span><span class="hljs-params">(<span class="hljs-type">const</span> AbstractPlanNodeRef &amp;plan)</span> -&gt; AbstractPlanNodeRef </span>&#123;<br>  std::vector&lt;AbstractPlanNodeRef&gt; children;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;child : plan-&gt;<span class="hljs-built_in">GetChildren</span>()) &#123;<br>    children.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-built_in">OptimizeNLJAsIndexJoin</span>(child));<br>  &#125;<br>  <span class="hljs-keyword">auto</span> optimized_plan = plan-&gt;<span class="hljs-built_in">CloneWithChildren</span>(std::<span class="hljs-built_in">move</span>(children));<br><br>  <span class="hljs-keyword">if</span> (optimized_plan-&gt;<span class="hljs-built_in">GetType</span>() == PlanType::NestedLoopJoin) &#123;<br>    <span class="hljs-comment">// apply the rule and return</span><br>  &#125;<br><br>  <span class="hljs-keyword">return</span> optimized_plan;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ plan tree è¿›è¡Œååºéå†ï¼Œè‡ªåº•å‘ä¸Šåœ°é€‚ç”¨è§„åˆ™ï¼Œæ”¹å†™èŠ‚ç‚¹ã€‚éå†åˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ if è¯­å¥æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦ç¬¦åˆæˆ‘ä»¬è¦ä¼˜åŒ–çš„ç±»å‹ï¼Œè‹¥ç¬¦åˆåˆ™è¿›è¡Œä¼˜åŒ–ã€‚</p><p>å¤§è‡´äº†è§£å¦‚ä½•å¯¹ plan è¿›è¡Œä¼˜åŒ–åï¼Œå°±å¯ä»¥å¼€å§‹å†™æˆ‘ä»¬çš„ä¼˜åŒ–è§„åˆ™äº†ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œèƒ½ä¼˜åŒ–ä¸ºä¸€ä¸ª TopN ç®—å­çš„å½¢å¼æ˜¯ï¼Œä¸Šå±‚èŠ‚ç‚¹ä¸º Limitï¼Œä¸‹å±‚èŠ‚ç‚¹ä¸º Sortï¼Œä¸èƒ½åè¿‡æ¥ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯¹ plan tree è¿›è¡Œåç»­éå†ï¼Œåœ¨é‡åˆ° Limit æ—¶ï¼Œåˆ¤æ–­å…¶ä¸‹å±‚èŠ‚ç‚¹æ˜¯å¦ä¸º Sortï¼Œè‹¥ä¸º Sortï¼Œåˆ™å°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸ºä¸€ä¸ª TopNã€‚è¿˜æ˜¯æ¯”è¾ƒå¥½å®ç°çš„ï¼Œåªæ˜¯ä»£ç çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¤æ‚ã€‚</p><h2 id="leaderboard-task"><a class="markdownIt-Anchor" href="#leaderboard-task"></a> Leaderboard Task</h2><p>æš‚æ—¶è¿˜æ²¡å†™ï¼Œæœ‰ç©ºäº†è¡¥è¡¥</p><p><strong>AC!</strong><br /><img src="../img/busTub/query_excution/p3-result.png" alt="" /></p><h2 id="resources"><a class="markdownIt-Anchor" href="#resources"></a> Resources</h2><ul><li><a href="https://15445.courses.cs.cmu.edu/fall2022/bustub/">bustub on web</a></li><li><a href="https://15445.courses.cs.cmu.edu/fall2022">è¯¾ç¨‹å®˜ç½‘</a></li><li><a href="https://github.com/cmu-db/bustub">Github Repo</a></li><li><a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;ab_channel=CMUDatabaseGroup">Youtubeè¯¾ç¨‹è§†é¢‘ 2022fall</a> ï¼ˆå¦‚æœå¯¹è‹±æ–‡å­—å¹•æœ‰å‹åŠ›çš„è¯å¯ä»¥åœ¨ chrome æ’ä»¶é‡Œä¸‹ä¸ªä¸­è‹±æ–‡åŒå­—å¹•æ’ä»¶ï¼‰</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>database</tag>
      
      <tag>cmu15445</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç®—æ³•ç«èµ›ä¸­çš„Wavelet Tree</title>
    <link href="/%E7%AE%97%E6%B3%95%E7%AB%9E%E8%B5%9B%E4%B8%AD%E7%9A%84Wavelet-Tree/"/>
    <url>/%E7%AE%97%E6%B3%95%E7%AB%9E%E8%B5%9B%E4%B8%AD%E7%9A%84Wavelet-Tree/</url>
    
    <content type="html"><![CDATA[<h1 id="wavelet-tree-for-competitive-programming"><a class="markdownIt-Anchor" href="#wavelet-tree-for-competitive-programming"></a> Wavelet Tree for Competitive Programming</h1><blockquote><p>æœ€è¿‘åœ¨å­¦<em>FM-Index</em>ç›¸å…³ç®—æ³•ç”¨äºæ•°æ®åº“ï¼Œäº†è§£åˆ°Wavelet Treeè¿™ä¸€æ•°æ®ç»“æ„ï¼Œå‘ç°å…¶è¿˜å¯ä»¥åº”ç”¨åœ¨ç®—æ³•ç«èµ›ä¸­ã€‚ç½‘ä¸Šç›¸å…³ä¸­æ–‡èµ„æ–™æ¯”è¾ƒå°‘ï¼Œæƒå½“è‡ªå·±åšä¸ªå­¦ä¹ ç¬”è®°</p></blockquote><h2 id="å¼€å§‹ä¹‹å‰"><a class="markdownIt-Anchor" href="#å¼€å§‹ä¹‹å‰"></a> å¼€å§‹ä¹‹å‰</h2><p>åœ¨å­¦ä¹ <code>wavelet tree</code>å‰ï¼Œä¸å¦¨çœ‹çœ‹ä»–èƒ½è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€é•¿ä¸º <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span> çš„åºåˆ— <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo stretchy="false">[</mo><mn>0...</mn><mi>n</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A[0...n - 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">A</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> ã€‚åœ¨ç®—æ³•ç«èµ›ä¸­ï¼Œå…¸å‹çš„æ•°æ®é‡æ˜¯  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>=</mo><mn>1</mn><mi>e</mi><mn>5</mn><mo separator="true">,</mo><mi mathvariant="normal">âˆ£</mi><mi>A</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mi mathvariant="normal">âˆ£</mi><mo>&lt;</mo><mo>=</mo><mn>1</mn><mi>e</mi><mn>9</mn></mrow><annotation encoding="application/x-tex">n = 1e5,  |A[i]| &lt;= 1e9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord mathdefault">e</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">âˆ£</span><span class="mord mathdefault">A</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mord">âˆ£</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord mathdefault">e</span><span class="mord">9</span></span></span></span></p><ul><li>åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>L</mi><mo separator="true">,</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[L, R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">L</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span> ä¸­å…ƒç´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>çš„<code>å‡ºç°æ¬¡æ•°</code></li><li>åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>L</mi><mo separator="true">,</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[L, R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">L</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span> ä¸­çš„<code>ç¬¬kå°æ•°</code></li><li>åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>L</mi><mo separator="true">,</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[L, R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">L</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span> ä¸Š <code>å°äºç­‰äºxçš„æ•°çš„ä¸ªæ•°</code></li><li>â€¦</li></ul><p>ä»¥ä¸Šé—®é¢˜éƒ½å¯ä»¥é€šè¿‡<em>å¯æŒä¹…åŒ–çº¿æ®µæ ‘</em>åœ¨è§£å†³ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦wavelet treeå‘¢ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å¯æŒä¹…åŒ–çº¿æ®µæ ‘çš„å¸¸æ•°å¾ˆå¤§ï¼Œå¹¶ä¸”ååˆ†æ¶ˆè€—ç©ºé—´ï¼Œåœ¨æœ‰äº›è‹›åˆ»çš„é¢˜ç›®ä¸‹å¯èƒ½ä¼šè¢«å¡  <s>å¥½å§åº”è¯¥éƒ½æ˜¯é‡‘ç‰Œé¢˜ï¼Œä¸æ˜¯æˆ‘è¯¥è€ƒè™‘çš„</s> ã€‚åˆ©ç”¨wavelet treeå¯ä»¥åœ¨<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>Ïƒ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">log(\sigma)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">Ïƒ</span><span class="mclose">)</span></span></span></span>æ—¶é—´å†…å®Œæˆçš„åŒæ—¶ï¼ˆä¸”ä¼˜ç§€çš„å¸¸æ•°ï¼‰ï¼Œè‹¥ä½¿ç”¨<code>bitvector</code>ä¼˜åŒ–ç©ºé—´ï¼Œç©ºé—´ä¸Šå¤§æ¦‚æ¯”å¯æŒä¹…åŒ–çº¿æ®µæ ‘å°‘ä¸€ä¸ªé‡çº§ã€‚æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä¸ªäººè§‰å¾—ä»–æ¯”ä¸»å¸­æ ‘æ›´åŠ ç›´è§‚æ˜“æ‡‚ã€‚<br /><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>Ïƒ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> = | <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">Î£</mi><mo>=</mo><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>â‹¯</mo><mtext>â€‰</mtext><mo separator="true">,</mo><mi>Ïƒ</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\Sigma = \{1, 2, \cdots, \sigma\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Î£</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">â‹¯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">Ïƒ</span><span class="mclose">}</span></span></span></span>| ï¼ˆç”¨äºåºåˆ—ä¸Šæ—¶æ˜¯å€¼åŸŸå¤§å°ï¼‰ã€‚</p><blockquote><p>ç”¨wavelet treeçš„ç¼ºç‚¹å°±æ˜¯å¸¦ä¿®æ”¹æ“ä½œæ¯”è¾ƒéš¾å†™ï¼Œç é‡è¾ƒå¤§ï¼Œä¸€èˆ¬ä¸ä¼šåœ¨æ¯”èµ›æ—¶ä½¿ç”¨ã€‚</p></blockquote><h2 id="wavelet-tree"><a class="markdownIt-Anchor" href="#wavelet-tree"></a> Wavelet Tree</h2><p><img src="../img/waveletTree/waveletTree.png" alt="" /></p><p>è¯¥å›¾ç»™å‡ºäº†ç”¨åºåˆ— <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>=</mo><mo stretchy="false">[</mo><mn>7</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>5</mn><mo separator="true">,</mo><mn>6</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>7</mn><mo separator="true">,</mo><mn>8</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A = [7, 3, 5, 6, 1, 3, 2, 7, 8, 4]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">6</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">4</span><span class="mclose">]</span></span></span></span> æ„å»ºçš„wavelet treeçš„å½¢æ€ã€‚å¯¹äºæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä¼šå°†å…¶æŒ‰ç…§å€¼åŸŸåˆ†æˆä¸¤ä¸ªéƒ¨åˆ†<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mi>o</mi><mi>w</mi><mo separator="true">,</mo><mi>m</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">[</mo><mi>m</mi><mi>i</mi><mi>d</mi><mo separator="true">,</mo><mi>h</mi><mi>i</mi><mi>g</mi><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[low, mid), [mid, high)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">h</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">h</span><span class="mclose">)</span></span></span></span>ã€‚é€šè¿‡ <strong>ç¨³å®šåˆ’åˆ†</strong>ï¼ˆstable_partitionï¼Œå³ä¸æ”¹å˜ç›¸å¯¹é¡ºåºçš„æƒ…å†µä¸‹åˆ’åˆ†ï¼‰å°†è¯¥èŠ‚ç‚¹ä¸Šçš„åºåˆ—ä¸­å°äº <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span></span></span></span>çš„åˆ’åˆ†åˆ°å·¦å­æ ‘ä¸­ï¼Œå¤§äºç­‰äºmidçš„åˆ’åˆ†åˆ°å³å­æ ‘ä¸­ï¼Œé€’å½’ç›´è‡³èŠ‚ç‚¹ä¸­åªæœ‰ä¸€ç§å€¼æ—¶ä¸ºå¶èŠ‚ç‚¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šåœ¨å¶å­èŠ‚ç‚¹ä¸­ç›´æ¥å­˜å‚¨åºåˆ—çš„å€¼ï¼Œè€Œæ˜¯é€šè¿‡æŸä¸ªæ–¹æ³•ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨è¾ƒå°çš„ç©ºé—´çš„æƒ…å†µä¸‹å¾—åˆ°è¶³å¤Ÿçš„ä¿¡æ¯ã€‚</p><p>è®¾æ ¹èŠ‚ç‚¹ç¼–å·ä¸º <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>u</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">u = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">u</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> ï¼Œå…¶å·¦å­æ ‘çš„æ ¹èŠ‚ç‚¹ä¸º <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mo>âˆ—</mo><mi>u</mi></mrow><annotation encoding="application/x-tex">2 * u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">u</span></span></span></span> , å³å­æ ‘çš„æ ¹èŠ‚ç‚¹ä¸º <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mo>âˆ—</mo><mi>u</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2 * u + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">u</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯¹åº”ä¸€å¯¹å·¦é—­å³å¼€çš„åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mi>o</mi><mo separator="true">,</mo><mi>h</mi><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[lo, hi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">h</span><span class="mord mathdefault">i</span><span class="mclose">)</span></span></span></span>ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹ä¸­æ•°å€¼çš„å€¼åŸŸèŒƒå›´ã€‚åŒæ—¶æœ‰ä¸€ä¸ª <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>m</mi><mi>i</mi><mi>d</mi><mo>=</mo><mo stretchy="false">âŒŠ</mo><mfrac><mrow><mi>l</mi><mi>o</mi><mo>+</mo><mi>h</mi><mi>i</mi></mrow><mn>2</mn></mfrac><mo stretchy="false">âŒ‹</mo></mrow><annotation encoding="application/x-tex">mid = \lfloor \frac{lo + hi}{2} \rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mopen">âŒŠ</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">o</span><span class="mbin mtight">+</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">âŒ‹</span></span></span></span> ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å·¦å³å­æ ‘åˆ†è£‚æ ‡å‡†ï¼Œå³å·¦å­æ ‘ä¸­å€¼åŸŸèŒƒå›´æ˜¯ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mi>o</mi><mo separator="true">,</mo><mi>m</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[lo, mid)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mclose">)</span></span></span></span> , å³å­æ ‘ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>m</mi><mi>i</mi><mi>d</mi><mo separator="true">,</mo><mi>h</mi><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[mid, hi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">h</span><span class="mord mathdefault">i</span><span class="mclose">)</span></span></span></span> ã€‚</p><p>åœ¨wavelet treeä¸­ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨ç»´æŠ¤ä¸€ä¸ªäºŒç»´æ•°ç»„<code>vector&lt;vector&lt;int&gt;&gt; c</code>ï¼Œæˆ‘ä»¬ä¸å¦¨å«ä»–<strong>å‰ç¼€è®¡æ•°æ•°ç»„</strong>ï¼Œå…¶ä¸­ <strong><code>c[u][i]</code>è¡¨ç¤ºçš„æ˜¯uç»“ç‚¹ä¸­ä¸‹æ ‡ä¸º[0, i)ä¸­çš„æ•°æœ‰å¤šå°‘ä¸ªå°äºè¯¥èŠ‚ç‚¹å¯¹åº”çš„mid</strong>ã€‚å¦å¤–ï¼Œè‹¥<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">u</span></span></span></span>ç»“ç‚¹ä¸­æœ‰<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>ä¸ªæ•°ï¼Œé‚£ä¹ˆ<code>c[u].size() = n + 1</code>ï¼Œ æˆ‘ä»¬å¦<code>c[u][0] = 0</code>ã€‚ä¾‹å¦‚ï¼Œä¸‹å›¾ç»™å‡ºäº†éƒ¨åˆ†ç»“ç‚¹å¯¹åº”çš„ <code>c[u][i]</code>æ•°ç»„<br /><img src="../img/waveletTree/Counting-array.png" alt="" /></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹å¦‚ä½•ç”¨è¿™ä¸ªæ„å»ºå¥½çš„å‰ç¼€è®¡æ•°æ•°ç»„å®Œæˆä»¥ä¸‹çš„æŸ¥è¯¢é—®é¢˜ï¼š</p><h3 id="rankint-val-int-pos"><a class="markdownIt-Anchor" href="#rankint-val-int-pos"></a> rank(int val, int pos)</h3><p>è¯¥å‡½æ•°è¿”å›åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[0, pos)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span> ä¸­å€¼ä¸º<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span></span></span>çš„æ•°çš„ä¸ªæ•°ï¼ˆæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆå«rankã€‚ã€‚ã€‚æˆ–è®¸è¿™ä¸ªåç§°æ˜¯ç”±bitvectorä¸­ç»§æ‰¿è€Œæ¥ï¼Ÿï¼‰ã€‚æœ‰äº†è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å®¹æ˜“å¾—åˆ°åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[i, j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span> å†…æŸä¸ªæ•°çš„å‡ºç°æ¬¡æ•°ï¼Œå°±æ˜¯ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><mi>k</mi><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>âˆ’</mo><mi>r</mi><mi>a</mi><mi>n</mi><mi>k</mi><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">rank(val, j) - rank(val, i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">i</span><span class="mclose">)</span></span></span></span></p><p>è®¾ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mi>u</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">rank_u (val, pos)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span> ä¸ºç»“ç‚¹<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">u</span></span></span></span>ä¸­å€¼ä¸ºvalçš„æ•°åœ¨ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[0, pos)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span> ä¸­çš„å‡ºç°æ¬¡æ•°ï¼ˆ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mo>&lt;</mo><mo>=</mo><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">pos &lt;= size(u)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">u</span><span class="mclose">)</span></span></span></span> ï¼‰<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span></span></span></span>ä¸ºèŠ‚ç‚¹<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">u</span></span></span></span>åˆ†è£‚æ ‡å‡†ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š</p><ul><li>è‹¥ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mo>&lt;</mo><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">val &lt; mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span></span></span></span>ï¼Œåˆ™ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mi>u</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mrow><mi>L</mi><mi>e</mi><mi>f</mi><mi>t</mi><mi>C</mi><mi>h</mi><mi>i</mi><mi>l</mi><mi>d</mi><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>c</mi><mo stretchy="false">[</mo><mi>u</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">rank_u(val, pos) = rank_{LeftChild(u)}(val, c[u][pos])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3551999999999999em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">u</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">c</span><span class="mopen">[</span><span class="mord mathdefault">u</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span></li><li>è‹¥ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mo>&gt;</mo><mo>=</mo><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">val &gt;= mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span></span></span></span>,  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mi>u</mi></msub><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mrow><mi>R</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>C</mi><mi>h</mi><mi>i</mi><mi>l</mi><mi>d</mi><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo>âˆ’</mo><mi>c</mi><mo stretchy="false">[</mo><mi>u</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">rank_u(val, pos) = rank_{RightChild(u)}(val, pos - c[u][pos])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3551999999999999em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">u</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mopen">[</span><span class="mord mathdefault">u</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span></li></ul><p>å¦‚ä½•ç†è§£ä¸Šè¿°å˜åŒ–å‘¢ï¼Œå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯è¦ç†è§£<code>c[u][i]</code>çš„æ„ä¹‰ï¼Œå®ƒåŒæ—¶ä¹Ÿè¡¨ç¤ºå°†uç»“ç‚¹ä¸­ä¸‹æ ‡ä¸ºiçš„ç‚¹æ˜ å°„åˆ°å­ç»“ç‚¹ä¸­åä»–çš„ä½ç½®ã€‚è€Œæ˜ å°„è§„åˆ™ä¸º<strong>è‹¥è¿™ä¸ªæ•°å°äºmidï¼Œåˆ™å°†å…¶æ˜ å°„åˆ°å·¦å„¿å­çš„c[u][i]å¤„ï¼›è‹¥è¿™ä¸ªæ•°å¤§äºç­‰äºmidï¼Œåˆ™å°†å…¶æ˜ å°„åˆ°å³å„¿å­çš„i-c[u][i]å¤„</strong> ä¸ç†è§£çš„å¯å†ä»”ç»†æƒ³æƒ³<code>c[u][i]</code>çš„è¿™ä¸¤ä¸ªè§£é‡Šä¹‹é—´çš„ç­‰ä»·æ€§ã€‚</p><p>æœ‰äº†ä¸Šè¿°è¯´æ˜ï¼Œæˆ‘ä»¬å°±å®¹æ˜“é€’å½’çš„å®Œæˆ<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><mi>k</mi></mrow><annotation encoding="application/x-tex">rank</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span>æ“ä½œã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦å¾—åˆ° <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo>=</mo><mn>3</mn><mo separator="true">,</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo>=</mo><mn>7</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">rank_1(val = 3, pos = 7)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">7</span><span class="mclose">)</span></span></span></span><br />-ç”±äº <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>&lt;</mo><mi>m</mi><mi>i</mi><mi>d</mi><mi mathvariant="normal">ï¼Œ</mi><mi>c</mi><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mn>7</mn><mo stretchy="false">]</mo><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">3&lt;midï¼Œc[1][7] = 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord mathdefault">c</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord">7</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span>, åˆ™é€’å½’å·¦å­æ ‘ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">rank_2(3, 4)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">4</span><span class="mclose">)</span></span></span></span>ï¼›</p><ul><li>å·¦å­æ ‘ä¸­ï¼Œ<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>&gt;</mo><mo>=</mo><mo stretchy="false">(</mo><mi>m</mi><mi>i</mi><mi>d</mi><mo>=</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>4</mn><mo>âˆ’</mo><mi>c</mi><mo stretchy="false">[</mo><mn>2</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mn>4</mn><mo stretchy="false">]</mo><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 &gt;= (mid = 2), 4-c[2][4] = 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mopen">[</span><span class="mord">2</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord">4</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>ï¼Œé€’å½’åˆ°å³å­æ ‘ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mn>5</mn></msub><mo stretchy="false">(</mo><mn>3</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">rank_5(3, 3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mclose">)</span></span></span></span></li><li>å³å­æ ‘ä¸­ï¼Œ<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>&gt;</mo><mo>=</mo><mo stretchy="false">(</mo><mi>m</mi><mi>i</mi><mi>d</mi><mo>=</mo><mn>3</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>3</mn><mo>âˆ’</mo><mi>c</mi><mo stretchy="false">[</mo><mn>5</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mn>3</mn><mo stretchy="false">]</mo><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">3 &gt;= (mid = 3), 3-c[5][3] = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mopen">[</span><span class="mord">5</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord">3</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>ï¼Œé€’å½’åˆ°å³å­æ ‘</li><li>å³å­æ ‘ä¸ºå¶å­èŠ‚ç‚¹ï¼Œåˆ™æ­¤æ—¶ç»“ç‚¹å†…çš„æ ‘çš„ä¸ªæ•°ï¼ˆå³ä¸ºä¸Šä¸€æ­¥ä¸­ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>âˆ’</mo><mi>c</mi><mo stretchy="false">[</mo><mn>5</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mn>3</mn><mo stretchy="false">]</mo><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">3-c[5][3] = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mopen">[</span><span class="mord">5</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord">3</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>ï¼‰ä¸º<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span></span></span>çš„ä¸ªæ•°</li></ul><h3 id="quantileint-k-int-l-int-r"><a class="markdownIt-Anchor" href="#quantileint-k-int-l-int-r"></a> quantile(int k, int l, int r)</h3><p>è¯¥å‡½æ•°è¿”å›åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[l, r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span>é—´çš„ç¬¬kå°æ•°ï¼ˆæœ€å°çš„ä¸ºç¬¬ä¸€å°ï¼‰ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ<code>c[u][l]</code>è¡¨ç¤ºä¸‹æ ‡ä¸ºç»“ç‚¹ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">u</span></span></span></span>ä¸­æœ‰å¤šå°‘ä¸ªä¸‹æ ‡åœ¨ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mi mathvariant="normal">ï¼Œ</mi><mi>l</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[0ï¼Œ l)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mclose">)</span></span></span></span>ä¸­çš„æ•°è¢«æ˜ å°„åˆ°äº†å·¦å­æ ‘ã€‚é‚£ä¹ˆï¼Œ</p><ul><li>è‹¥<code>c[u][r] - c[u][l] &gt;= k</code>ï¼Œåˆ™åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[l, r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span>å†…ç¬¬kå°å³ä¸ºå·¦å­æ ‘ä¸­çš„ç¬¬kå°ã€‚</li><li>è‹¥<code>c[u][r] - c[u][l] &lt; k</code>ï¼Œåˆ™åŒºé—´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[l, r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span>å†…ç¬¬kå°å³ä¸ºå³å­æ ‘ä¸­çš„ç¬¬<code>k - (c[u][r] - c[u][l])</code>å°ã€‚</li></ul><p>ä»è€Œæˆ‘ä»¬å¯ä»¥é€’å½’çš„è¿›è¡Œæ±‚è§£ã€‚</p><h3 id="cæ•°ç»„çš„æ„å»º"><a class="markdownIt-Anchor" href="#cæ•°ç»„çš„æ„å»º"></a> cæ•°ç»„çš„æ„å»º</h3><p>å®é™…ä¸Šä¸Šé¢å·²ç»è®²çš„å·®ä¸å¤šäº†ï¼Œç›´æ¥çœ‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// å‚æ•°éƒ½æ˜¯è¯¥ç»“ç‚¹å¯¹åº”åºåˆ—ç›¸å…³</span><br><span class="hljs-comment">// u: è¯¥ç»“ç‚¹ç¼–å·</span><br><span class="hljs-comment">// beginï¼Œ end: è¯¥ç»“ç‚¹å¯¹åº”åºåˆ—çš„é¦–ä¸ªï¼Œæœ«å°¾è¿­ä»£å™¨</span><br><span class="hljs-comment">// lo, hiï¼š è¯¥ç»“ç‚¹å¯¹åº”å€¼åŸŸä¸º [lo, hi)</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(iter begin, iter end, <span class="hljs-type">int</span> lo, <span class="hljs-type">int</span> hi, <span class="hljs-type">int</span> u)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span>(hi - lo == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-type">int</span> m = (lo + hi) / <span class="hljs-number">2</span>;<br>    c[u].<span class="hljs-built_in">reserve</span>(end - begin + <span class="hljs-number">1</span>); <span class="hljs-comment">// reverseåªåˆ†é…ç©ºé—´ä¸è¿›è¡Œæ„é€ ï¼Œæ‰€ä»¥åé¢è¿˜å¯ä»¥push_back</span><br>    c[u].<span class="hljs-built_in">push_back</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = begin; it != end; ++it) &#123;<br>        c[u].<span class="hljs-built_in">push_back</span>(c[u].<span class="hljs-built_in">back</span>() + (*it &lt; m));<br>    &#125;<br><br>    <span class="hljs-comment">// ç¨³å®šåˆ’åˆ†ï¼Œå°†[begin, end)é—´çš„å°äºmçš„å€¼åˆ’åˆ†åˆ°å‰åŠéƒ¨åˆ†ï¼Œpivotä¸ºååŠéƒ¨åˆ†é¦–ä¸ªè¿­ä»£å™¨</span><br>    <span class="hljs-keyword">auto</span> pivot = <span class="hljs-built_in">stable_partition</span>(begin, end, [=](<span class="hljs-type">int</span> i)&#123;<span class="hljs-keyword">return</span> i &lt; m&#125;;);<br><br>    <span class="hljs-built_in">build</span>(begin, pivot, lo, m, <span class="hljs-number">2</span> * u);<br>    <span class="hljs-built_in">build</span>(pivot, end, m, hi, <span class="hljs-number">2</span> * u + <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™ä¸ªï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥åˆ©ç”¨æ²¡æœ‰è¿›è¡Œç©ºé—´ä¼˜åŒ–çš„wavelet treeè½»æ¾åˆ‡æ‰è¿™é“ <a href="https://www.luogu.com.cn/problem/P3834">å¯æŒä¹…åŒ–çº¿æ®µæ ‘çš„æ¨¡æ¿é¢˜</a>äº†ï¼Œä»£ç å¦‚ä¸‹</p><h2 id="æ¨¡æ¿"><a class="markdownIt-Anchor" href="#æ¨¡æ¿"></a> æ¨¡æ¿</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WaveletTree</span> &#123;<br>    <span class="hljs-keyword">using</span> iter = vector&lt;<span class="hljs-type">int</span>&gt;::iterator;<br>    vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; c;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> SIGMA;<br><br>    <span class="hljs-built_in">WaveletTree</span>(vector&lt;<span class="hljs-type">int</span>&gt; a, <span class="hljs-type">int</span> sigma): <span class="hljs-built_in">c</span>(sigma*<span class="hljs-number">2</span>), <span class="hljs-built_in">SIGMA</span>(sigma) &#123;<br>        <span class="hljs-built_in">build</span>(a.<span class="hljs-built_in">begin</span>(), a.<span class="hljs-built_in">end</span>(), <span class="hljs-number">0</span>, SIGMA, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(iter begin, iter end, <span class="hljs-type">int</span> lo, <span class="hljs-type">int</span> hi, <span class="hljs-type">int</span> u)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(hi - lo == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-type">int</span> m = (lo + hi) / <span class="hljs-number">2</span>;<br>        c[u].<span class="hljs-built_in">reserve</span>(end - begin + <span class="hljs-number">1</span>);<br>        c[u].<span class="hljs-built_in">push_back</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = begin; it != end; ++it) &#123;<br>            c[u].<span class="hljs-built_in">push_back</span>(c[u].<span class="hljs-built_in">back</span>() + (*it &lt; m));<br>        &#125;<br><br>        <span class="hljs-keyword">auto</span> p = <span class="hljs-built_in">stable_partition</span>(begin, end, [=](<span class="hljs-type">int</span> i)<br>                                  &#123; <span class="hljs-keyword">return</span> i &lt; m; &#125;);<br>        <span class="hljs-built_in">build</span>(begin, p, lo, m, <span class="hljs-number">2</span> * u);<br>        <span class="hljs-built_in">build</span>(p, end, m, hi, <span class="hljs-number">2</span> * u + <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// occurrences of val in position[0, i)</span><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">rank</span><span class="hljs-params">(<span class="hljs-type">int</span> val, <span class="hljs-type">int</span> i)</span> <span class="hljs-type">const</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(val &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> val &gt;= SIGMA) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-type">int</span> lo = <span class="hljs-number">0</span>, hi = SIGMA, u = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span>(hi - lo &gt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-type">int</span> m = (lo + hi) / <span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">if</span>(val &lt; m) &#123;<br>                i = c[u][i], hi = m;<br>                u = u * <span class="hljs-number">2</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                i -= c[u][i], lo = m;<br>                u = u * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> i;<br>    &#125;<br>    <br>    <span class="hljs-comment">// get kth smallest number in [l, r)</span><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">quantile</span><span class="hljs-params">(<span class="hljs-type">int</span> k, <span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> <span class="hljs-type">const</span> </span>&#123;<br>        <span class="hljs-comment">// assert(k &gt; 0 &amp;&amp; k &lt;= j - i);</span><br>        <span class="hljs-type">int</span> lo = <span class="hljs-number">0</span>, hi = SIGMA, u = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span>(hi - lo &gt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-type">int</span> m = (lo + hi) / <span class="hljs-number">2</span>;<br>            <span class="hljs-type">int</span> nl = c[u][l], nr = c[u][r];<br>            <span class="hljs-keyword">if</span>(k &lt;= nr - nl) &#123;<br>                r = nr, l = nl, hi = m;<br>                u = <span class="hljs-number">2</span> * u;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                k -= nr - nl;<br>                r -= nr, l -= nl, lo = m;<br>                u = <span class="hljs-number">2</span> * u + <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> lo;   <br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);<br>    cin.<span class="hljs-built_in">tie</span>(<span class="hljs-literal">nullptr</span>); cout.<span class="hljs-built_in">tie</span>(<span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-type">int</span> n, q;<br>    cin &gt;&gt; n &gt;&gt; q;<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">a</span><span class="hljs-params">(n)</span></span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> &amp;x : a) &#123;<br>        cin &gt;&gt; x;<br>    &#125;<br>    <span class="hljs-function">WaveletTree <span class="hljs-title">wt</span><span class="hljs-params">(a, *max_element(a.begin(), a.end()) + <span class="hljs-number">1</span>)</span></span>;<br>    <span class="hljs-keyword">while</span>(q --) &#123;<br>        <span class="hljs-type">int</span> k, l, r;<br>        cin &gt;&gt; l &gt;&gt; r &gt;&gt; k;<br>        l--;<br>        cout &lt;&lt; wt.<span class="hljs-built_in">quantile</span>(k, l, r) &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>icpc</tag>
      
      <tag>data-structure</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CMU15445-project2 Concurrent B+ tree</title>
    <link href="/CMU15445-project2-Concurrent-B-tree/"/>
    <url>/CMU15445-project2-Concurrent-B-tree/</url>
    
    <content type="html"><![CDATA[<h2 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> Overview</h2><blockquote><p>è¿™ä¸ªå®éªŒåº”è¯¥æ˜¯æœ€éš¾çš„ä¸€ä¸ªå®éªŒäº†ã€‚ã€‚ã€‚ï¼ˆæ„Ÿè§‰å’ŒProject 4 â€”â€” Transactionå®ç°çš„éš¾åº¦å·®ä¸å¤šï¼‰ å¦å¤–ï¼Œ2022fallç‰ˆæœ¬çš„B+ treeæ›´æ˜¯å˜æ€ï¼Œå› ä¸ºå‡ ä¹æ²¡æœ‰ç»™ä»»ä½•å†…éƒ¨çš„APIï¼Œè®©äººæ— ä»ä¸‹æ‰‹ã€‚å»ºè®®åˆ° Github repo é‡Œæ‰¾åˆ°20å¹´çš„ï¼Œæˆ‘åŸºæœ¬æ˜¯æ ¹æ®é‡Œé¢å®šä¹‰çš„å‡½æ•°æ¥å®ç°çš„ã€‚</p></blockquote><p>å®éªŒææ–™<s>è´´å¿ƒçš„</s>ä¸ºä½ åˆ†æˆäº†ä¸¤ä¸ªæ£€æŸ¥ç‚¹ï¼Œå››ä¸ªå°ä»»åŠ¡ã€‚</p><p>Checkpoint #1</p><ul><li>Task #1 - B+Tree Pages</li><li>Task #2 - B+Tree Data Structure (Insertion, Deletion, Point Search)</li></ul><p>Checkpoint #2</p><ul><li>Task #3 - Index Iterator</li><li>Task #4 - Concurrent Index</li></ul><h2 id="task-1-btree-pages"><a class="markdownIt-Anchor" href="#task-1-btree-pages"></a> Task #1 - B+Tree Pages</h2><p>ç¬¬ä¸€ä¸ªä»»åŠ¡ç®—æ˜¯çƒ­èº«ï¼Œä¸»è¦æ˜¯ææ¸…æ¥š B+ æ ‘çš„ä¸€äº›ç±»ä¹‹é—´çš„å…³ç³»ã€‚<br />æˆ‘ä»¬çŸ¥é“ï¼Œæ•°æ®åº“ä¸­çš„ç´¢å¼•ä¹Ÿæ˜¯æ•°æ®ï¼ŒåŒæ ·ä»¥ page çš„å½¢å¼è¢«ç»„ç»‡ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¦å®Œæˆçš„è¿™äº›ç±»ä¹‹é—´çš„å…³ç³»ã€‚</p><p><img src="../img/busTub/B-tree/B-tree-page-relation.png" alt="" /></p><p><code>B+ tree internal page</code> ä¸ <code>B + tree leaf page</code> éƒ½ç»§æ‰¿è‡ª<code>B + tree page</code>ï¼Œ<code>B + tree page</code> ä¸­å®šä¹‰äº† B+ æ ‘æ¯ä¸ªç»“ç‚¹çš„ä¸€äº›ä¿¡æ¯ã€‚è€ŒB + Tree è¿™ä¸ªç±»åˆ™æ˜¯Checkpoint 1çš„ä¸»è¦å¯¹è±¡ï¼Œå®ƒå¯¹<code>internal page</code> ä»¥åŠ <code>leaf page</code> è¿›è¡Œç®¡ç†ï¼Œå¹¶å¯¹å¤–å¼€æ”¾æ¥å£ã€‚è€Œåœ¨å†…å­˜ä¸­ï¼Œinternal page ä¸ leaf page éƒ½å±äº page çš„ä¸€éƒ¨åˆ†ï¼Œå…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ä»–ä»¬å°±æ˜¯ <code>page</code> ä¸­çš„ data éƒ¨åˆ†ã€‚å› æ­¤ï¼Œæ¯æ¬¡<br />ä» buffer pool manager å¾—åˆ°ä¸€ä¸ª page åï¼Œè‹¥æ˜¯å°†ä»–ä»¬ç”¨ä½œ B+æ ‘çš„ç»“ç‚¹ï¼Œåˆ™éœ€è¦å¯¹è¿™ä¸ª data è¿›è¡Œ<strong>é‡Šä¹‰</strong>ï¼Œä¹Ÿå°±æ˜¯å°†ä»–å¼ºåˆ¶è½¬åŒ–ä¸ºinternal page æˆ–è€… leaf pageã€‚è¿™åœ¨ C++ ä¸­é€šè¿‡ <a href="https://en.cppreference.com/w/cpp/language/reinterpret_cast"><strong>reinterpret_cast</strong></a> å®Œæˆã€‚</p><p><img src="../img/busTub/B-tree/pages.png" alt="" /></p><p>ç„¶åå°±æ˜¯ä¸€äº›getterï¼Œsetterçš„å®ç°ã€‚è¿™ä¸ª <code>MappingType array[1]</code> æ˜¯ä¸ªå¥‡æŠ€æ·«å·§å«<a href="https://en.wikipedia.org/wiki/Flexible_array_member">flexible array member</a>ï¼Œç”±äºæ•´ä¸ªinternal pageçš„å¤§å°æ˜¯ç¡®å®šçš„ï¼ˆç”±data[buffer_size]è½¬ä¹‰è€Œæ¥ï¼‰ï¼Œè¿™ä¸ª array çš„å¤§å°å°±æ˜¯å»æ‰ headeråçš„å¤§å°ã€‚ï¼ˆå¦å¤–ï¼Œå®é™…ä¸Šåº”è¯¥å†™ä½œ <code>MappingType array[0]</code>ï¼Œä¸ç„¶è¿‡ä¸äº† check-formatï¼‰ã€‚</p><h2 id="task-2-btree-data-structure-insertion-deletion-point-search"><a class="markdownIt-Anchor" href="#task-2-btree-data-structure-insertion-deletion-point-search"></a> Task #2 - B+Tree Data Structure (Insertion, Deletion, Point Search)</h2><p>è¿™ä¸ªä»»åŠ¡å°±æ˜¯æœ¬å®éªŒæœ€ä¸ºæ ¸å¿ƒçš„ä¸€ç‚¹â€”â€”å®ç°åŸºäºç£ç›˜çš„ B+ æ ‘æ•°æ®ç»“æ„ã€‚è¿™é‡Œä¸ä¼šè¯¦ç»†å±•å¼€ï¼Œå› ä¸ºè¿‡äºå¤æ‚ä¸”å¾ˆå¤šç»†èŠ‚<s>å› ä¸ºå¿˜å…‰äº†</s>ã€‚ç»™ä¸ª<a href="https://github.com/cmu-db/bustub/blob/1cc1bb2f7b0746c67a974c0554c843ac35519315/src/storage/index/b_plus_tree.cpp">20å¹´fall</a>çš„B+ treeï¼ŒåŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æä¾›äº†å®Œå–„çš„å†…éƒ¨æ¥å£ï¼Œç…§ç€è¿™ä¸ªå’Œä¹¦ä¸Šå®Œæˆè¦æ¸…æ™°ä¸å°‘ã€‚</p><h3 id="debug"><a class="markdownIt-Anchor" href="#debug"></a> debug</h3><p>TAså‡†å¤‡äº†b_plus_tree_printerå·¥å…·ï¼Œå¹¶ä¸”å·²ç»å‡†å¤‡çš„Draw/ToStringæ–¹æ³•ï¼Œå–„ç”¨å®ƒä»¬å°†B+æ ‘å¯è§†åŒ–ï¼Œæ›´å¥½çš„è§‚å¯Ÿæ’å…¥ã€åˆ é™¤è¡Œä¸ºæ˜¯å¦æ­£ç¡®ã€‚ ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> step = <span class="hljs-number">0</span>;     <br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> key : keys) &#123;       <br>  <span class="hljs-type">int64_t</span> value = key &amp; <span class="hljs-number">0xFFFFFFFF</span>;       <br>  rid.<span class="hljs-built_in">Set</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int32_t</span>&gt;(key &gt;&gt; <span class="hljs-number">32</span>), value);       <br>  index_key.<span class="hljs-built_in">SetFromInteger</span>(key);       <br>  tree.<span class="hljs-built_in">Insert</span>(index_key, rid, transaction);       <br>  tree.<span class="hljs-built_in">Draw</span>(bpm, <span class="hljs-string">&quot;xxxxx/InsertTest_step&quot;</span> + std::<span class="hljs-built_in">to_string</span>(step++) + <span class="hljs-string">&quot;_insert&quot;</span> + std::<span class="hljs-built_in">to_string</span>(key) + <span class="hljs-string">&quot;.dot&quot;</span>);     <br>&#125;     <br>tree.<span class="hljs-built_in">Draw</span>(bpm, <span class="hljs-string">&quot;xxxxxx/InsertTest_step.dot&quot;</span>);<br></code></pre></td></tr></table></figure><p>å¾—åˆ°ç”Ÿæˆçš„æ–‡ä»¶åæ‰“å¼€ï¼Œå¯ä»¥å’Œ<a href="https://15445.courses.cs.cmu.edu/fall2022/bpt-printer/">reference solution</a>æ¯”è¾ƒã€‚</p><h2 id="task-3-index-iterator"><a class="markdownIt-Anchor" href="#task-3-index-iterator"></a> Task #3 - Index Iterator</h2><p>æˆ‘æƒ³é‡ç‚¹è¯´ä¸‹è¿™ä¸ª iterator çš„å®ç°ï¼Œå› ä¸ºåœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘è°ƒäº†æœ€ä¹…çš„ bug å°±å‡ºç°åœ¨è¿™ä¸ªå­ä»»åŠ¡ä¸­ã€‚ï¼ˆå®é™…ä¸Šå·²ç»è¿‡äº†lab-2çš„è¯„æµ‹å·²ç»è¿‡äº†ï¼Œæ˜¯åœ¨ lab3è¯„æµ‹æ—¶å‘ç”Ÿé”èµ„æºçš„é—®é¢˜ï¼‰</p><p>è®°å¾—å“ªä¸ªå¤§ä½¬è¯´è¿‡ï¼Œå¦‚ä½•çœ‹ä¸€ä¸ªäººçš„ C++ æ°´å¹³ï¼Œä»ä»–å†™çš„æ„é€ å‡½æ•°å°±å¯ä»¥ç•¥çª¥ä¸€äºŒã€‚C++ çš„æ„é€ å‡½æ•°å±å®èŠ±é‡Œèƒ¡å“¨ï¼Œ<code>copy ctor</code>, <code>copy assignment</code>, <code>move ctor</code>, <code>move assignment</code> , å†åŠ ä¸Š <code>initializatier list</code>ä»¥åŠæ¨¡æ¿â€¦ å“ªäº›è¦å†™ï¼Œå“ªäº›åº”å½“ç¦æ­¢éƒ½æ˜¯é—¨å­¦é—®ã€‚</p><p>æ ¹æ® <a href="https://zh.wikipedia.org/zh-hans/RAII">RAII</a> çš„æ€æƒ³ï¼ŒC++ çš„ contructorï¼ˆé…åˆdtorï¼‰è‚©è´Ÿäº†ç®¡ç†èµ„æºçš„ä½œç”¨ã€‚è¿™ä¸ªèµ„æºä¸çŸ¥åŒ…æ‹¬å†…å­˜èµ„æºï¼Œè¿˜åŒ…æ‹¬é”èµ„æºç­‰ç­‰ã€‚è€Œå¯¹äº Index iterator æ¥è¯´ï¼Œæ¯ä¸ª iterator éƒ½å¸¦æœ‰ä¸€ä¸ªéšå«çš„è¯»å±æ€§ï¼Œå¹¶å‘è¯»è¦æ±‚å¯¹ page ä¸Šè¯»é”ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ iterator åˆä¸ç›´æ¥ç®¡ç† page èµ„æºï¼Œéœ€è¦é€šè¿‡ä¼ å…¥æŒ‡é’ˆï¼ˆç”¨shared_ptræœ€å¥½ï¼‰çš„æ–¹å¼å¯¹ page è¿›è¡Œæ“ä½œã€‚</p><p>æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªä¾‹å­ åœ¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">index_iter_ = <span class="hljs-built_in">GetBPlusTreeIndex</span>()-&gt;<span class="hljs-built_in">GetBeginIterator</span>();<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯lab3ä¸­ç”¨åˆ°ç´¢å¼•è¿­ä»£å™¨çš„ä¸€ä¸ªåœ°æ–¹çš„ä»£ç ã€‚æ³¨æ„åˆ°è¿™ä¼šäº§ç”Ÿä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œå¹¶æŠŠå®ƒèµ‹å€¼ç»™ index_iter_ã€‚å¦‚æœæˆ‘ä»¬åœ¨ææ„çš„æ—¶å€™é‡Šæ”¾äº†å¯¹åº” page çš„é”è€Œæ²¡æœ‰å†™<code>copy assignment</code>ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„assignmentæ˜¯ä¸ä¼šåœ¨èµ‹å€¼çš„æ—¶å€™ä¸ºpageä¸Šé”çš„ã€‚</p><p>è¿™ä¸ªbugå½’æ ¹ç»“åº•åœ¨äºï¼Œæˆ‘ä»¬çš„è¿­ä»£å™¨åº”è¯¥æ˜¯ <strong>å€¼è¯­ä¹‰(value semantic)</strong> çš„ï¼ˆè‡³å°‘å¯¹äºé”èµ„æºæ¥è®²ï¼‰</p><p>æˆ‘ä»¬ç”¨ <strong>copy and swap</strong> idiom æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="hljs-function"><span class="hljs-title">INDEXITERATOR_TYPE::IndexIterator</span><span class="hljs-params">(BufferPoolManager *bpm, Page *page, <span class="hljs-type">int</span> index, <span class="hljs-type">page_id_t</span> page_id)</span></span><br><span class="hljs-function">    : bpm_(bpm), page_(page), index_(index), page_id_(page_id) &#123;</span><br>  <span class="hljs-keyword">if</span> (page != <span class="hljs-literal">nullptr</span>) &#123;<br>    leaf_ = <span class="hljs-built_in">reinterpret_cast</span>&lt;LeafPage *&gt;(page-&gt;<span class="hljs-built_in">GetData</span>());<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    leaf_ = <span class="hljs-literal">nullptr</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-function">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="hljs-function"><span class="hljs-title">INDEXITERATOR_TYPE::IndexIterator</span><span class="hljs-params">(<span class="hljs-type">const</span> IndexIterator &amp;rhs)</span></span><br><span class="hljs-function">    : bpm_(rhs.bpm_), index_(rhs.index_), page_id_(rhs.page_id_), leaf_(rhs.leaf_) &#123;</span><br>  <span class="hljs-keyword">if</span> (page_id_ != INVALID_PAGE_ID) &#123;<br>    page_ = bpm_-&gt;<span class="hljs-built_in">FetchPage</span>(page_id_);<br>    page_-&gt;<span class="hljs-built_in">RLatch</span>();<br>  &#125;<br>&#125;<br><br>INDEX_TEMPLATE_ARGUMENTS<br><span class="hljs-keyword">auto</span> INDEXITERATOR_TYPE::<span class="hljs-keyword">operator</span>=(IndexIterator rhs) -&gt; IndexIterator &amp; &#123;<br>  <span class="hljs-built_in">Swap</span>(*<span class="hljs-keyword">this</span>, rhs);<br>  <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">Swap</span><span class="hljs-params">(IndexIterator &amp;lhs, IndexIterator &amp;rhs)</span> </span>&#123;<br>  <span class="hljs-keyword">using</span> std::swap;<br>  <span class="hljs-built_in">swap</span>(lhs.bpm_, rhs.bpm_);<br>  <span class="hljs-built_in">swap</span>(lhs.page_, rhs.page_);<br>  <span class="hljs-built_in">swap</span>(lhs.index_, rhs.index_);<br>  <span class="hljs-built_in">swap</span>(lhs.page_id_, rhs.page_id_);<br>  <span class="hljs-built_in">swap</span>(lhs.leaf_, rhs.leaf_);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="task-4-index-iterator"><a class="markdownIt-Anchor" href="#task-4-index-iterator"></a> Task #4 - Index Iterator</h2><p>è¿™æ˜¯å¹¶å‘ B+ æ ‘çš„é‡ç‚¹ã€‚æˆ‘ä»¬è¦ä½¿æ­¤å‰å®ç°çš„ B+ æ ‘æ”¯æŒå¹¶å‘çš„ Search/Insert/Delete æ“ä½œã€‚æ•´æ£µæ ‘ä¸€æŠŠé”é€»è¾‘ä¸Šæ¥è¯´å½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†æ€§èƒ½è‚¯å®šä¸è¡Œï¼Œæˆ‘ä»¬éœ€è¦æ›´åŠ ç»†ç²’åº¦çš„é”ç®¡ç†ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„åŠ é”æ–¹å¼ï¼Œå«åš latch crabbingã€‚é¡¾åæ€ä¹‰ï¼Œå°±åƒèƒèŸ¹ä¸€æ ·ï¼Œç§»åŠ¨ä¸€åªè„šï¼Œæ”¾ä¸‹ï¼Œç§»åŠ¨å¦ä¸€åªè„šï¼Œå†æ”¾ä¸‹ã€‚åŸºæœ¬æ€æƒ³æ˜¯ï¼š</p><ol><li>å…ˆé”ä½ parent pageï¼Œ</li><li>å†é”ä½ child pageï¼Œ</li><li>å‡è®¾ child page æ˜¯å®‰å…¨çš„ï¼Œåˆ™é‡Šæ”¾ parent page çš„é”ã€‚å®‰å…¨æŒ‡å½“å‰ page åœ¨å½“å‰æ“ä½œä¸‹ä¸€å®šä¸ä¼šå‘ç”Ÿ split/steal/mergeã€‚åŒæ—¶ï¼Œå®‰å…¨å¯¹ä¸åŒæ“ä½œçš„å®šä¹‰æ˜¯ä¸åŒçš„ï¼ŒSearch æ—¶ï¼Œä»»ä½•èŠ‚ç‚¹éƒ½å®‰å…¨ï¼›Insert æ—¶ï¼Œåˆ¤æ–­ max sizeï¼›Delete æ—¶ï¼Œåˆ¤æ–­ min sizeã€‚</li></ol><p>è¿™ä¹ˆåšçš„åŸå› å’Œæ­£ç¡®æ€§è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ã€‚å½“ page ä¸ºå®‰å…¨çš„æ—¶å€™ï¼Œå½“å‰æ“ä½œä»…å¯èƒ½æ”¹å˜æ­¤ page åŠå…¶ child page çš„å€¼ï¼Œå› æ­¤å¯ä»¥æå‰é‡Šæ”¾æ‰å…¶ç¥–å…ˆçš„é”æ¥æé«˜å¹¶å‘æ€§èƒ½ã€‚</p><p>æœ€åæ˜¯ACæˆªå›¾ï¼š</p><p><img src="../img/busTub/B-tree/p2-result.png" alt="" /></p><h2 id="resources"><a class="markdownIt-Anchor" href="#resources"></a> Resources</h2><ul><li><a href="https://15445.courses.cs.cmu.edu/fall2022">è¯¾ç¨‹å®˜ç½‘</a></li><li><a href="https://github.com/cmu-db/bustub">Github Repo</a></li><li><a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;ab_channel=CMUDatabaseGroup">Youtubeè¯¾ç¨‹è§†é¢‘ 2022fall</a> ï¼ˆå¦‚æœå¯¹è‹±æ–‡å­—å¹•æœ‰å‹åŠ›çš„è¯å¯ä»¥åœ¨ chrome æ’ä»¶é‡Œä¸‹ä¸ªä¸­è‹±æ–‡åŒå­—å¹•æ’ä»¶ï¼‰</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>database</tag>
      
      <tag>cmu15445</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CMU15445-project1 Buffer Pool Manager</title>
    <link href="/CMU15445-project1-Buffer-Pool-Manager/"/>
    <url>/CMU15445-project1-Buffer-Pool-Manager/</url>
    
    <content type="html"><![CDATA[<h1 id="buffer-pool-manager"><a class="markdownIt-Anchor" href="#buffer-pool-manager"></a> Buffer Pool Manager</h1><blockquote><p>cmu15445 æ˜¯ä¸€é—¨å…³äºæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰è®¾è®¡ä¸å®ç°çš„ç»å…¸å…¬å¼€è¯¾ï¼Œæ˜¯å¾ˆå¤šdbaå’Œå†…æ ¸å¼€å‘äººå‘˜çš„å…¥é—¨è¯¾ç¨‹ã€‚å¼€è¯¾æ•™æˆAndy Pavlo éå¸¸é£è¶£å¹½é»˜ï¼Œä»–æœ‰è‡ªå·±ä¸Šè¯¾çš„DJï¼Œä»–æ›¾åœ¨æµ´ç¼¸é‡Œå½•è¯¾ï¼Œä¸”æ—¶å¸¸è¯­å‡ºæƒŠäººã€‚è¿™é—¨è¯¾çš„å®éªŒé¡¹ç›®BusTubéå¸¸æœ‰æŒ‘æˆ˜æ€§ï¼Œå¹¶å¯¹æ‰€æœ‰äººå¼€æ”¾è¯„æµ‹èµ„æºã€‚</p></blockquote><h2 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> Overview</h2><p>BusTubæ˜¯ä¸€ä¸ªé¢å‘ç£ç›˜çš„ DBMS(Database Management System)ã€‚ç”±äºç£ç›˜ä¸Šçš„æ•°æ®ä¸æ”¯æŒå­—èŠ‚ç²’åº¦çš„è®¿é—®ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªç®¡ç†é¡µçš„ä¸­é—´å±‚ï¼Œè€Œ Andy åšæŒ<a href="https://db.cs.cmu.edu/mmap-cidr2022/">&quot;The OS is not your friend&quot;</a>ï¼Œ åå¯¹ä½¿ç”¨ mmap è¿›è¡Œé¡µæ“ä½œï¼Œå› æ­¤å®éªŒä¸€çš„ç›®æ ‡ä¾¿åœ¨äºé€šè¿‡å®ç° Buffer Pool Manager ä¸»åŠ¨ç®¡ç†ç£ç›˜ä¸­çš„é¡µï¼ˆpageï¼‰åœ¨å†…å­˜ä¸­çš„ç¼“å­˜ï¼Œä»è€Œï¼Œæœ€å°åŒ–ç£ç›˜è®¿é—®æ¬¡æ•°ï¼ˆæ—¶é—´ä¸Šï¼‰ã€æœ€å¤§åŒ–ç›¸å…³æ•°æ®è¿ç»­ï¼ˆç©ºé—´ä¸Šï¼‰ã€‚</p><p>è¿™æ¬¡å®éªŒæœ‰ä¸‰ä¸ªå­ä»»åŠ¡ï¼Œåˆ†åˆ«æ˜¯</p><ul><li>Task #1: Extendible Hash Table</li><li>Task #2: LRU-K Replacer</li><li>Task #3: Buffer Pool Manager Instance</li></ul><p>å¯æ‹“å±•å“ˆå¸Œè¡¨æ˜¯è¿™ä¸ªæ˜¯å®éªŒä¸­ç›¸å¯¹ç‹¬ç«‹çš„æ¨¡å—ã€‚è¿™é‡Œä¸ä¼šè®²å®ƒçš„ç»†èŠ‚ï¼Œåé¢çš„ä¸¤ä¸ªä»»åŠ¡ä¸­éœ€è¦ç”¨åˆ°å“ˆå¸Œè¡¨çš„åœ°æ–¹æˆ‘ç›´æ¥ç”¨std::unordered_mapæ›¿ä»£ï¼Œè€Œä¸”æ•ˆç‡è¿˜æ›´é«˜ã€‚åº”è¯¥æ˜¯å› ä¸º Extendible Hash Table è¦æ±‚çº¿ç¨‹å®‰å…¨ï¼Œä¸ºäº†æ–¹ä¾¿åœ¨æˆ‘åœ¨æ¯ä¸ªå‡½æ•°å…¥å£éƒ½åŠ äº†å¤§é”ã€‚<br />æƒ³è¦ Extendible Hash Table å…·ä½“ç»†èŠ‚çš„å¯ä»¥çœ‹è¿™ä¸ª<a href="https://www.bilibili.com/video/BV1nV4y1N7LM/?spm_id_from=333.788&amp;vd_source=11c680307875dda5d5b5c13fca2e5c57">bç«™è§†é¢‘</a>ã€‚å…³äºå®ƒçš„ä¼˜åŒ–ï¼Œæˆ‘æƒ³å¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„é”ç®¡ç†ç”šè‡³å†™ä¸€ä¸ªæ— é”(lockfree)çš„å“ˆå¸Œè¡¨ã€‚</p><h2 id="buffer-pool-manager-2"><a class="markdownIt-Anchor" href="#buffer-pool-manager-2"></a> Buffer Pool Manager</h2><p>åœ¨åä¸¤ä¸ªå®éªŒå¼€å§‹ä¹‹å‰ï¼Œæˆ‘å»ºè®®å…ˆå°†Task #2å’ŒTask #3çš„<a href="https://15445.courses.cs.cmu.edu/fall2022/project1/">å®éªŒææ–™</a>å®Œæ•´çš„çœ‹å®Œåœ¨å¼€å§‹å†™ä»£ç ã€‚å› ä¸º <code>replacer</code> å’Œ <code>buffer pool manager</code> æœ‰è¾ƒå¤§ç¨‹åº¦çš„è€¦åˆã€‚å¾ˆå¤šAPIè®¾è®¡éœ€è¦å¯¹ç…§ä¸¤ä¸ªç»„ä»¶æ‰èƒ½çŸ¥é“è‡ªå·±åº”è¯¥ç»´æŠ¤çš„æ•°æ®ä¸åŠŸèƒ½çš„è¾¹ç•Œã€‚ä¸ºäº†æ›´ç¬¦åˆç›´è§‰ï¼Œæˆ‘ä¼šå…ˆé˜è¿° <code>buffer pool manager</code> çš„è®¾è®¡ï¼ŒåŒæ—¶ä¼šç©¿æ’ç€ <code>LRU-k</code> çš„APIä»€ä¹ˆæ—¶å€™ï¼Œåœ¨å“ªç”¨ã€‚</p><p><strong>Buffer Pool Manager</strong> ç»´æŠ¤çš„æ•°æ®çš„åŸºæœ¬å•ä½ä¸ºä¸€æ®µé€»è¾‘è¿ç»­çš„å­—èŠ‚æ•°ç»„ï¼Œåœ¨ç£ç›˜ä¸Šè¡¨ç°ä¸º<strong>é¡µï¼ˆpageï¼‰</strong>ï¼Œé¡µå†…éƒ¨ç»“æ„æœ‰è‡ªå·±çš„ä¸€äº›ç»“æ„ï¼ˆåŒ…æ‹¬header, contentç­‰ï¼‰ï¼Œåœ¨è¿™ä¸ªå®éªŒä¸­æˆ‘ä»¬åªå…³å¿ƒ <code>page_id_</code> (é¡µçš„å”¯ä¸€æ ‡è¯†)ï¼Œ <code>pin_conut_</code> ä»¥åŠ <code>is_dirty_</code> ã€‚å¯¹åº”åœ¨å†…å­˜ä¸Šï¼Œæˆ‘ä»¬ç”¨ <strong>frame</strong> è¿™ä¸ªè¯ä»£è¡¨ <strong>æ¡†</strong>ï¼Œå°±æ˜¯è£…ç€æŸä¸ªç‰©ç†é¡µçš„æ¡†ã€‚åœ¨ä»£ç ä¸­å…¶å®å°±æ˜¯buffer poolç®¡ç†ç€ä¸€å¤§ç‰‡å†…å­˜ <code>Page pages[pool_size_]</code>ï¼Œä½†æ˜¯ buffer pool åˆå§‹åŒ–æ—¶ï¼ˆèµ„æºè·å–æ—¶ï¼‰æˆ‘ä»¬å¾—åˆ°çš„ pages å¹¶ä¸åŒ…å«æˆ‘ä»¬æƒ³è¦çš„é¡µï¼Œå®ƒé‡Œé¢çš„æ•°æ®æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä»è€Œå®ƒæ˜¯ä¸€ä¸ª<em>ç©ºçš„æ¡†</em>ã€‚frame_idæŒ‡çš„å°±æ˜¯è¿™ä¸ªæ•°ç»„çš„ä¸‹æ ‡ã€‚é‡Œé¢è£…çš„é¡µæœ‰è‡ªå·±çš„<code>page_id</code>ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªå“ˆå¸Œè¡¨<code>page_table_</code>ä¿å­˜ä» é¡µå·(page id) åˆ° æ¡†å·(frame_id) çš„æ˜ å°„ã€‚</p><img src="../img/busTub/buffer_pool_manager/pages.png" width="75%" height="75%"><p>ç®¡ç†å¸§çš„å†…å­˜æ± å¤§å°ä¸€èˆ¬æ¥è¯´æ˜¯è¿œå°äºç£ç›˜çš„ï¼Œå› æ­¤åœ¨å†…å­˜æ± æ»¡äº†åï¼Œå†ä»ç£ç›˜åŠ è½½æ–°çš„é¡µåˆ°å†…å­˜æ± ï¼Œéœ€è¦æŸç§æ›¿æ¢ç­–ç•¥ï¼ˆreplacerï¼‰å°†ä¸€äº›ä¸å†ä½¿ç”¨çš„é¡µè¸¢å‡ºå†…å­˜æ± ä»¥è…¾å‡ºç©ºé—´ã€‚</p><p>buffer pool manager çš„<strong>å®ç°æ ¸å¿ƒ</strong>åœ¨äºå¯¹æ‰€æœ‰ page çš„çŠ¶æ€çš„ç®¡ç†ã€‚æ¯ä¸ªpageæœ‰å››ç§çŠ¶æ€ï¼š</p><ol><li><strong>Not Allocated(Not Exist):</strong> æˆ‘ä»¬å°†ä¸å­˜åœ¨çš„ page ä¹Ÿå½“ä½œä¸€ç§çŠ¶æ€</li><li><strong>Allocated but Not in MEM:</strong> allocated ä½†æ˜¯ä¸å­˜åœ¨äºå†…å­˜ä¸­ï¼ˆæŸä¸€æ—¶åˆ»å†…å­˜è£…çš„ page è¾¾åˆ°ä¸Šçº¿åè¢« evict å‡ºå†…å­˜ï¼‰</li><li><strong>Unpinned and in MEM:</strong> éšæ—¶å¯èƒ½è¢« evict</li><li><strong>Pinned(definitely in MEM)</strong></li></ol><p><strong>è¿™å‡ ç§çŠ¶æ€æ˜¯äº’æ–¥çš„</strong></p><p>å¾…å®ç°å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">BufferPoolManagerInstance::NewPgImp</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> *page_id)</span> -&gt; Page *</span><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">BufferPoolManagerInstance::FetchPgImp</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> page_id)</span> -&gt; Page *</span><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">BufferPoolManagerInstance::UnpinPgImp</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> page_id, <span class="hljs-type">bool</span> is_dirty)</span> -&gt; <span class="hljs-type">bool</span></span><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">BufferPoolManagerInstance::DeletePgImp</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> page_id)</span> -&gt; <span class="hljs-type">bool</span></span><br></code></pre></td></tr></table></figure><p>ä¾¿æ˜¯é©±åŠ¨çŠ¶æ€æœºä¸­ä¸Šè¿°çŠ¶æ€å‘ç”Ÿæ”¹å˜çš„åŠ¨ä½œï¼ˆactionï¼‰ï¼Œï¼ˆæ³¨æ„ï¼š <em>AllocatePage å’Œ DeallocatePage</em>ä¸å¯¹å¤–éƒ¨å…¬å¼€ï¼‰ çŠ¶æ€æœºå¦‚ä¸‹ï¼š</p><img src="../img/busTub/buffer_pool_manager/state-machine-of-page.png" width="50%" height="50%"><p>æ¯ä¸ªå‡½æ•°å£°æ˜å¤„çš„æ³¨é‡Šå·²ç»éå¸¸è¯¦ç»†çš„æè¿°äº†å‡½æ•°è¡Œä¸ºäº†ã€‚ä»¥ä¸‹åˆ—å‡ºä¸€äº›æˆ‘åœ¨åšçš„æ—¶å€™å®¹æ˜“å›°æƒ‘çš„ç‚¹ï¼š</p><ul><li><code>page_table_</code>ç»´æŠ¤çš„åªæ˜¯åœ¨å†…å­˜ä¸­çš„pageçš„<code>page_id</code>åˆ°<code>frame_id</code>çš„æ˜ å°„ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¿å­˜ <em>Allocated but not in MEM</em> çš„ pageï¼ˆå› ä¸ºåœ¨ç£ç›˜ä¸Šçš„pageä¹Ÿæ²¡æœ‰ä¸€ä¸ªåˆ° <code>frame_id</code> çš„æ˜ å°„ï¼‰</li><li><code>Unpin</code> æ“ä½œå¹¶ä¸ä¸€å®šä¼šä½¿ page å˜æˆ <em>Unpinned and in MEM</em>ï¼Œå› ä¸ºè¿™åªæ˜¯è¿™ä¸€ä¸ª <em>workerï¼ˆä¸€èˆ¬æ¥è¯´æ˜¯ä¸€ä¸ªthreadï¼‰</em> å¯¹è¯¥ page è¿›è¡Œ unpinï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¹Ÿæ­£åœ¨è¯»å–è¿™ä¸ª page çš„å†…å®¹ã€‚ åªæœ‰å½“ æŸæ¬¡ Unpin æ“ä½œåï¼Œå®ƒçš„<code>pin_count_</code> ç­‰äº0æ—¶ï¼Œæ‰èƒ½è®©è¿™ä¸ª page å˜æˆ <code>evitable</code>çš„çŠ¶æ€ï¼ˆåœ¨ replacer ä¸­ç»´æŠ¤ï¼‰</li><li><code>AllocatePage</code> åªåœ¨ <code>NewPage</code>ä¸­ç”¨åˆ°ï¼Œ<code>DeallocatePage</code> åªåœ¨ <code>DeletePage</code> ä¸­ç”¨åˆ°</li><li><code>Unpin</code> çš„ <code>is_dirty</code> å‚æ•°ä¸º true æ—¶ï¼Œå°†è¿™ä¸ª page çš„<code>is_dirty_</code>è®¾ç½®ä¸ºtrueï¼Œ <strong>è€Œå½“å‚æ•°ä¸ºfalseæ—¶ï¼Œä¸å¯ä»¥å°†pageçš„ is_dirty_ è®¾ç½®ä¸ºfalse! è€Œåº”è¯¥ä¿æŒåŸ dirty çŠ¶æ€ä¸å˜</strong> å› ä¸º <code>is_dirty</code> å‚æ•°è¡¨ç¤ºçš„åªæ˜¯è¿™ä¸ªçº¿ç¨‹æ˜¯å¦å¯¹è¿™ä¸ª page æœ‰ä¿®æ”¹æ“ä½œã€‚ï¼ˆè¿™ä¸ªç‚¹å®³æˆ‘debugäº†å¥½ä¹…ï¼‰</li></ul><p>ç°åœ¨æˆ‘ä»¬å€ŸåŠ© replacer çš„ API æ¥ç†è§£ä¸€ä¸‹æ¯ä¸ª page åœ¨ä»–çš„ç”Ÿå‘½å‘¨æœŸä¸­éœ€è¦è¢«ç»´æŠ¤ä»€ä¹ˆå†…å®¹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å‘ç”Ÿåœ¨NewPageå’ŒFetchPageæ—¶ï¼Œä¸”free_list_ä¸ºç©º</span><br><span class="hljs-comment"> * @param[out] frame_id id of frame that is evicted.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Evict</span><span class="hljs-params">(<span class="hljs-type">frame_id_t</span> *frame_id)</span> -&gt; <span class="hljs-type">bool</span></span>;<br><br><span class="hljs-comment">/* å‘ç”Ÿåœ¨NewPageå’ŒFetchPageä¸­ */</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RecordAccess</span><span class="hljs-params">(<span class="hljs-type">frame_id_t</span> frame_id)</span></span>;<br><br><span class="hljs-comment">/** åœ¨NewPageå’ŒFetchPage set_evictable è®¾ç½®ä¸º false</span><br><span class="hljs-comment"> *  åœ¨ Unpinåï¼Œpin_countä¸º0ä¸‹ set_evictable è®¾ç½®ä¸º true</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetEvictable</span><span class="hljs-params">(<span class="hljs-type">frame_id_t</span> frame_id, <span class="hljs-type">bool</span> set_evictable)</span></span>;<br><br><span class="hljs-comment">/* å‘ç”Ÿåœ¨DeletePageä¸­ */</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Remove</span><span class="hljs-params">(<span class="hljs-type">frame_id_t</span> frame_id)</span></span>;<br></code></pre></td></tr></table></figure><p>ä»¥ FetchPageImpl ä¸ºä¾‹å¼ºè°ƒä¸‹ä¸€äº›å®ç°çš„ç»†èŠ‚ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">BufferPoolManagerInstance::FetchPgImp</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> page_id)</span> -&gt; Page * </span>&#123;<br>  <span class="hljs-comment">// 1. ä¸Šé”ï¼</span><br>  <span class="hljs-comment">// 2. æŸ¥çœ‹ page æ˜¯å¦åœ¨ page_table_ ä¸­</span><br>  <span class="hljs-comment">//  2.1 è‹¥åœ¨ </span><br>  <span class="hljs-comment">//   2.1.2 å¾—åˆ°frame_id, ç›®æ ‡ä¸ºpages[frame_id]</span><br>  <span class="hljs-comment">//   2.1.3 ç›®æ ‡å†…éƒ¨çš„pin_countçŠ¶æ€ç»´æŠ¤</span><br>  <span class="hljs-comment">//   2.1.4 replacer ç»´æŠ¤recordAccesså’ŒsetEvictable</span><br>  <span class="hljs-comment">//   2.1.5 è¿”å›</span><br>  <span class="hljs-comment">// 2.2 è‹¥ä¸åœ¨</span><br>  <span class="hljs-comment">//  2.2.1 æ‰¾ä¸€ä¸ªå¯ç”¨çš„ frame (å…ˆä»free listé‡Œæ‰¾ï¼Œæ²¡æœ‰åˆ™è®© replacer evictä¸€ä¸ª)</span><br>  <span class="hljs-comment">//  2.2.2 æ¸…ç©ºframe_idä¸­åŸæ¥çš„ä¿¡æ¯ ï¼ˆåŒ…æ‹¬old_page dirtyçš„è¯å†™å›ç£ç›˜ï¼‰</span><br>  <span class="hljs-comment">//  2.2.3 ç»´æŠ¤ page_table (åˆ é™¤è¿™ä¸ªframe_idå¯¹åº”çš„old_pageçš„ä¿¡æ¯)</span><br>  <span class="hljs-comment">//  2.2.4 è®¾ç½®æ–°çš„page_idï¼Œä»ç£ç›˜ä¸­è¯»å…¥ï¼Œå¹¶ç»´æŠ¤æ–° page å†…éƒ¨ä¿¡æ¯</span><br>  <span class="hljs-comment">//  2.2.5 ç»´æŠ¤ replacer ç›¸å…³</span><br>  <span class="hljs-comment">//  2.2.6 ç»´æŠ¤page_table </span><br>  <span class="hljs-comment">//  2.2.7 è¿”å›</span><br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="lru-k-replacer"><a class="markdownIt-Anchor" href="#lru-k-replacer"></a> LRU-K Replacer</h2><p><strong>LRU-k evict policy</strong> æ˜¯è®©è®¿é—®æ¬¡æ•°æœªåˆ° k çš„ç»“ç‚¹ä¼šè¢«ä¼˜å…ˆ evict å‡ºå»ï¼ˆè¿™ä¹ˆåšæˆ–è®¸æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›å¾®å°çš„ <em>æ‰°åŠ¨è®¿é—®</em> æ±¡æŸ“äº†åŸæ¥ç»å¸¸è®¿é—®çš„åŒºåŸŸï¼‰ï¼Œç„¶åå¯¹äºè®¿é—®æ¬¡æ•°åˆ°è¾¾ k æ¬¡çš„ç»“ç‚¹åˆ™æŒ‰ç…§æœ€è¿‘è®¿é—®æ—¶é—´ï¼ˆæˆ–é€»è¾‘ä¸Šçš„æ—¶é—´æˆ³ï¼‰æœ€ä¹…è¿œçš„è¢« evictã€‚ï¼ˆå®é™…ä¸ŠæŒ‰ç…§åŸå§‹è®ºæ–‡å’Œ slides ä¸Šçš„æ„æ€åº”è¯¥æ˜¯æœ€è¿‘è®¿é—®æ—¶é—´å’Œç¬¬å‰ k æ¬¡è®¿é—®æ—¶é—´<strong>ä¹‹å·®</strong>ç›¸å·®æœ€å¤§çš„è¢« evictï¼Œä½†æ˜¯æŒ‰ç…§å‰é¢çš„æ–¹æ³•ä¹Ÿè¿‡äº†ã€‚ã€‚ã€‚ï¼‰</p><ul><li><a href="https://www.cs.cmu.edu/~natassa/courses/15-721/papers/p297-o_neil.pdf">LRU-kçš„åŸå§‹è®ºæ–‡</a></li><li><a href="https://leetcode.cn/problems/lru-cache/">leetcodeä¸Šçš„lruç®—æ³•</a>ï¼Œä¸ç†Ÿæ‚‰çš„å¯ä»¥å…ˆè¯•è¯•</li></ul><p>é’ˆå¯¹ LRU-k ç®—æ³•ï¼Œæˆ‘å®ç°äº†ä¸¤ç§æ–¹æ³•ï¼Œç®€å•è¯´ä¸€ä¸‹æ€è·¯ã€‚</p><h3 id="æ–¹æ³•ä¸€"><a class="markdownIt-Anchor" href="#æ–¹æ³•ä¸€"></a> æ–¹æ³•ä¸€</h3><p>ç»´æŠ¤ä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªå­˜æœªåˆ° k æ¬¡è®¿é—®çš„<code>frame_id</code>,å¦ä¸€ä¸ªå­˜å·²åˆ°ï¼ˆæˆ–è¶…è¿‡ï¼‰k æ¬¡è®¿é—®çš„ <code>frame_id</code>ï¼Œæˆ‘ä»¬åˆ†åˆ«å°†å…¶å«åš <code>history_list</code>ä»¥åŠ<code>cache_list</code>ã€‚</p><p>åŒæ—¶ç»´æŠ¤ä¸€ä¸ªä»<code>frame_id</code>åˆ° <code>FrameEntry</code>çš„å“ˆå¸Œè¡¨ï¼Œè¿™ä¸ª<code>FrameEntry</code>ä¿å­˜äº†<code>hit_count</code>ï¼Œ<code>evictible</code>ä»¥åŠä¸€ä¸ªlist&lt;frame_id_t&gt;çš„è¿­ä»£å™¨ã€‚</p><ul><li><strong>Evict:</strong> è‹¥ hist_list éç©ºï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª evictable çš„ frame å°†å…¶è¸¢å‡ºï¼Œå¦åˆ™æ‰¾cache_list ä¸­ç¬¬ä¸€ä¸ªevictable çš„ frameã€‚</li><li><strong>RecordAccess(frame_id):</strong>  é€šè¿‡ <code>FrameEntry</code> æŸ¥çœ‹ hit_count ï¼ˆ1ï¼‰è‹¥ä»–æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œåˆ™å°†å…¶æ”¾åœ¨ history_list å°¾éƒ¨ï¼Œæ³¨æ„ï¼ŒåŒæ—¶è¿˜è¦ç»´æŠ¤è¿™ä¸ª frame_id åœ¨FrameEntry ä¸­çš„è¿­ä»£å™¨ ã€‚ï¼ˆ2ï¼‰è‹¥ new_count == k åˆ™åœ¨history_listä¸­åˆ å»è¿™ä¸ªframe(æ— éœ€éå†ï¼Œé€šè¿‡ä¿å­˜åœ¨å“ˆå¸Œè¡¨ä¸­çš„è¿­ä»£å™¨è¿›è¡Œ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> åˆ é™¤)ï¼Œæ·»åŠ åˆ° cache_list ä¸­ï¼ŒåŒæ—¶ç»´æŠ¤å“ˆå¸Œè¡¨ ï¼ˆ3ï¼‰new_count &gt; kï¼Œå°†è¿™ä¸ª frame_id ç§»åŠ¨åˆ° cache_list æœ€åï¼ˆåˆ é™¤å’Œæ·»åŠ éƒ½å¯ä»¥åšåˆ° <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> ï¼‰</li><li><strong>SetEvictable</strong> å’Œ <strong>Remove</strong>éƒ½å¯ä»¥ç±»ä¼¼çš„æ“ä½œã€‚</li></ul><h3 id="æ–¹æ³•ä¸€æ—¶é—´å¤æ‚åº¦"><a class="markdownIt-Anchor" href="#æ–¹æ³•ä¸€æ—¶é—´å¤æ‚åº¦"></a> æ–¹æ³•ä¸€æ—¶é—´å¤æ‚åº¦ï¼š</h3><p>å‡è®¾ history_list å’Œ cache_list ä¸­çš„å…ƒç´ ä¸ªæ•°éƒ½æ˜¯ nï¼Œ ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ non-evictable çš„ä¸ªæ•°éƒ½ä¸º mï¼Œåˆ™ Evict çš„æ—¶é—´å¤æ‚åº¦ä¸º <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span>ï¼ˆæœ€å·®éå† m ä¸ªå…ƒç´ ï¼‰ å…¶ä½™æ“ä½œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRecordAccess è¦æ¯” Evict ç»å¸¸ä½¿ç”¨çš„å¤šï¼Œä¸” Evict éå† m ä¸ªå…ƒç´ æ˜¯åœ¨ non-evictable page éƒ½åœ¨ evictable page çš„å…ˆå‰è®¿é—®ã€‚å®é™…ä¸Šå¯ä»¥çœ‹ä½œä¸€ä¸ªå¸¸æ•°ã€‚</p><h3 id="æ–¹æ³•äºŒ"><a class="markdownIt-Anchor" href="#æ–¹æ³•äºŒ"></a> æ–¹æ³•äºŒ</h3><p>ä¸ºäº†ç»å¯¹ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> çš„ evictï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨std::setï¼ˆçº¢é»‘æ ‘ï¼‰ï¼Œç»“ç‚¹å†…éƒ¨ç»´æŠ¤ <em>hit_count</em> å’Œ <em>åˆ°è¾¾æ—¶é—´</em>ï¼Œéœ€è¦é‡è½½&lt;=ï¼Œå°±å¯ä»¥è¾¾åˆ°ã€‚ä½†æ˜¯è¿™ç§åšæ³•ä¸ä»…å¸¸æ•°å¤§ï¼ˆç»“ç‚¹ä¹‹é—´æ¯”è¾ƒéœ€è¦å…ˆæ¯”è¾ƒè®¿é—®äº†kæ¬¡æ²¡æœ‰ï¼Œå¯¹åˆ°è¾¾kæ¬¡å’Œæ²¡åˆ°è¾¾kæ¬¡çš„ç»“ç‚¹è¿˜éœ€åˆ†åˆ«æ¯”è¾ƒï¼‰ï¼Œæ›´è‡´å‘½çš„æ˜¯å®ƒä½¿å¾— <code>RecordAccess(frame_id)</code>çš„å¤æ‚åº¦å˜æˆ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(log(n))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span> ï¼ˆéœ€è¦ä¸€æ¬¡ findï¼Œ ä¸€æ¬¡ deleteï¼Œä¸€æ¬¡ insertï¼‰ã€‚</p><h2 id="summary"><a class="markdownIt-Anchor" href="#summary"></a> Summary</h2><p>è¿™æ˜¯å››ä¸ªå®éªŒï¼ˆä¸ç®—primerï¼‰ä¸­æœ€ç®€å•çš„ä¸€ä¸ªäº†ï¼Œå¦‚æœå®åœ¨å¡åœ¨æŸéƒ¨åˆ†çš„è¯è¯•è¯•é€šè¿‡åˆ†ææµ‹è¯•æ ·ä¾‹æ¥å¾—åˆ°é¢„æœŸè¡Œä¸ºï¼Œæˆ–è€…ä½¿ç”¨ gdb ï¼ˆå¯ä»¥ä½¿ç”¨ lldb é…åˆ vscode ä»£æ›¿å‘½ä»¤è¡Œæ¡ä»¶ä¸‹è¿›è¡Œè°ƒè¯•ï¼‰ã€‚ç›¸ä¿¡æˆ‘ï¼Œè¶Šæ—©å­¦ä¼šå¦‚ä½•è°ƒè¯•å¯¹åé¢è¶Šæœ‰ç›Šã€‚</p><p>æœ€åå½“ç„¶æ˜¯ AC æˆªå›¾äº†</p><p><img src="../img/busTub/buffer_pool_manager/p1-result.png" alt="" /></p><h2 id="resources"><a class="markdownIt-Anchor" href="#resources"></a> Resources</h2><ul><li><a href="https://15445.courses.cs.cmu.edu/fall2022">è¯¾ç¨‹å®˜ç½‘</a></li><li><a href="https://github.com/cmu-db/bustub">Github Repo</a></li><li><a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;ab_channel=CMUDatabaseGroup">Youtubeè¯¾ç¨‹è§†é¢‘ 2022fall</a> ï¼ˆå¦‚æœå¯¹è‹±æ–‡å­—å¹•æœ‰å‹åŠ›çš„è¯å¯ä»¥åœ¨ chrome æ’ä»¶é‡Œä¸‹ä¸ªä¸­è‹±æ–‡åŒå­—å¹•æ’ä»¶ï¼‰</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>database</tag>
      
      <tag>cmu15445</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>cs144-note1</title>
    <link href="/cs144-note1/"/>
    <url>/cs144-note1/</url>
    
    <content type="html"><![CDATA[<h1 id="computer-network"><a class="markdownIt-Anchor" href="#computer-network"></a> Computer Network</h1><h2 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> introduction</h2><p>dominant model : bidirectional, reliable byte stream connection</p><ul><li><p><strong>http</strong>: hypertext transfer protocol : designed to be a document centric way for programs to communicate.<br />Client  â€”&gt;  Server  model</p></li><li><p><strong>Bit-Torrent</strong>: (peer-to-peer model) a client requests document from other clients, a single client can request from many others.<br />these collections of collaborating clients are called <strong>swarms</strong><br />when a client wants to downloads a file, it first find <code>torrent</code>, usually using www and download using http.<br /><strong>torrent</strong> file describes information about data file, also tells bit-torrent about the <strong>tracker</strong> (a node keeps track names of clients of the swarm)</p></li><li><p><strong>skype</strong>: client &lt;â€“NATâ€“&gt;client   two clients request data from each other</p><p><em>NAT</em> : network address translator<br />if youâ€™re <em>behind a NAT</em>, you can open connections out to the internet, but other nodes on the internet canâ€™t easily open connections to you.</p></li></ul><h2 id="the-4-layer-internet-model"><a class="markdownIt-Anchor" href="#the-4-layer-internet-model"></a> The 4 layer Internet Model</h2><h3 id="network-layer-and-link-layer"><a class="markdownIt-Anchor" href="#network-layer-and-link-layer"></a> Network layer and link layer</h3><img src = "../img/cs144/4LayerModel.png" align="left" width="300px" height="430"/><span style="float:left"></span> The Internet is made up of `event hosts`, `links` and `routers`. <p>data is delivered in <strong>packets</strong><br />a packet is a self-contained unit consisting of the data we want to be delivered.</p><p>link layerâ€™s job is  to carry the data over one link  at a time.<br /><code>ethernet</code> and <code>wifi</code> --&gt; two examples of different links layers</p><p>Network layerâ€™s job is to deliver packets end to end across the internet.<br /><strong>a packet is a collection data with header</strong>.<br /><img src = "../img/cs144/packet.png" align="right" width="380" height ="100px"/></p><p>network layer packet are called <code>datagram</code>.</p><p><img src="../img/cs144%5CNetwork_link.png" alt="" /></p><h3 id="the-network-layer-is-special"><a class="markdownIt-Anchor" href="#the-network-layer-is-special"></a> The network layer  is â€œspecialâ€</h3><p>we must use the internet Protocol (IP)</p><ul><li>IP makes a best-effort attempt to deliver our datagrams to the other end. <strong>But it make no promise</strong></li><li>IP datagrams can get lost, delivered out of order, and be corrupted. <strong>No guarantees</strong>.</li></ul><h3 id="transport-layer"><a class="markdownIt-Anchor" href="#transport-layer"></a> Transport layer</h3><p>the most common transport layer is <strong>TCP</strong> (transmission control protocol)</p><ul><li>guarantee correct in-order delivery of data</li></ul><p>some applications doesnâ€™t need reliable delivery, it can use <strong>UDP</strong> (user datagram protocol).</p><ul><li>an alternative transport layer that bundles up application data and hands it to the network layer</li><li>it offers no delivery guarantees at all</li></ul><h3 id="application"><a class="markdownIt-Anchor" href="#application"></a> Application</h3><p>they have their own protocol to define the syntax and semantics of data flowing between two end points<br />(e.g. http, bit-torrent)</p><h3 id="others"><a class="markdownIt-Anchor" href="#others"></a> others</h3><img src = "../img/cs144/IP_is_thin.png" width="700px" height="350"/><img src = "../img/cs144/OSI-model.png" width="700px" height="350"/><h2 id="ip-service-model"><a class="markdownIt-Anchor" href="#ip-service-model"></a> IP Service model</h2><table><thead><tr><th>Property</th><th>behavior</th></tr></thead><tbody><tr><td>Datagram</td><td>Individually routed packets.</td></tr><tr><td>Unreliable</td><td>packet might be dropped</td></tr><tr><td>Best effort</td><td>only if necessary</td></tr><tr><td>Connectionless</td><td>No per-flow state.</td></tr></tbody></table><p><strong>IP is &quot;simple&quot;</strong></p><ul><li>faster, lower cost to build and maintain</li><li>The end-to-end principle</li><li>allows a variety of reliable (or unreliable) service to be built on top</li><li>make very few assumptions about link layer</li></ul><p><strong>IP Service Model</strong></p><ol><li>Tried to prevent packets looping forever<br />add a hop count field in the header of every datagram (<code>ttl</code>:time to live), start at a number like 128, decremented by every router passes through, when it reaches 0, IP think it be stuck in a loop then drop it.</li><li>will fragment packets if they are too long.<br />bc most links have a limit on the size of packets.(ethernet â€“ 1500bytes)</li><li>uses a header checksum to reduce chances of delivering datagram to wrong destination.</li><li>allows for new version of IP<ul><li>IPv4     32 bit addresses</li><li>IPv6     128 bit addresses</li></ul></li><li>allows for new options to be added to header</li></ol><img src = "../img/cs144/IPv4-datagram.png"  width="500px" /><h2 id="life-of-a-packet"><a class="markdownIt-Anchor" href="#life-of-a-packet"></a> Life of a Packet</h2><h3 id="three-way-handshake"><a class="markdownIt-Anchor" href="#three-way-handshake"></a> three-way handshake</h3><ol><li><p>Client -----sends a synchronized message(åŒæ­¥ä¿¡æ¯)-----&gt; Server   (synchronize, <strong>SYN</strong>)</p></li><li><p>Server -----responds with a synchronized message and also acknowledges the client synchronize----&gt; Client   (synchronize and acknowledge, <strong>SYN/ACK</strong>)</p></li><li><p>Client -----responds by acknowledging the server synchronized ----&gt; Server   (acknowledge, <strong>ACK</strong>)</p></li></ol><p>IP addressed:  like computer addresses.<br />TCP port: tells which applications to deliver data to.</p><p>Web Server usually run on tcp port 80.</p><p><img src="../img/cs144/inside-the-stream.png" alt="" /></p>]]></content>
    
    
    
    <tags>
      
      <tag>ComputerNetwork</tag>
      
      <tag>cs144</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>xcpc template</title>
    <link href="/xcpc-template/"/>
    <url>/xcpc-template/</url>
    
    <content type="html"><![CDATA[<h2 id="icpcæ¨¡æ¿"><a class="markdownIt-Anchor" href="#icpcæ¨¡æ¿"></a> icpcæ¨¡æ¿</h2><div class="row">    <embed src="../img/icpc-algorithm-template/catch22-algorithm-template.pdf" width="100%" height="550" type="application/pdf"></div><h1 id="algorithm-template"><a class="markdownIt-Anchor" href="#algorithm-template"></a> algorithm-template</h1><blockquote><p>Competitive Programming template</p></blockquote><h2 id="basic-algorithm"><a class="markdownIt-Anchor" href="#basic-algorithm"></a> basic algorithm</h2><ul><li>[x] åŒæŒ‡é’ˆ</li><li>[x] ç¦»æ•£åŒ–ï¼Œå»é‡</li><li>[x] å‰ç¼€å’Œä¸å·®åˆ†</li><li>[x] äºŒåˆ†</li><li>[x] å•è°ƒæ ˆ</li><li>[x] å•è°ƒé˜Ÿåˆ—</li><li>[x] å°ºå–æ³•</li><li>[ ] å½’å¹¶æ’åºï¼Œå¿«é€Ÿæ’åºï¼Œç¬¬kå°</li><li>[x] æ ‘çš„ä¸­å¿ƒ</li><li>[x] æ‹“æ‰‘æ’åº</li></ul><h2 id="math"><a class="markdownIt-Anchor" href="#math"></a> math</h2><ul><li>[x] ç´ æ•°ï¼Œç­›ç´ æ•°ï¼Œç´ æ€§æµ‹è¯•ï¼Œ åç´ æ•°</li><li>[x] è´¨å› æ•°åˆ†è§£ï¼Œé¢„å¤„ç†è´¨å› æ•°</li><li>[x] æ¬§æ‹‰å‡½æ•°</li><li>[x] ç»„åˆæ•°</li><li>[x] æ‹“å±•æ¬§å‡ é‡Œå¾—ï¼Œçº¿æ€§åŒä½™æ–¹ç¨‹</li><li>[ ] ä¸­å›½å‰©ä½™å®šç†</li><li>[x] å®¹æ–¥åŸç†</li><li>[x] é«˜æ–¯æ¶ˆå…ƒï¼Œé«˜æ–¯å¼‚æˆ–</li><li>[x] çŸ©é˜µä¹˜æ³•</li><li>[ ] åšå¼ˆè®ºï¼ŒNimæ¸¸æˆ</li><li>[x] è«æ¯”ä¹Œæ–¯åæ¼”</li><li>[x] BSGS</li><li>[x] FFT</li><li>[ ] ç”Ÿæˆå‡½æ•°</li><li>[ ] çº¿æ€§åŸº</li></ul><h2 id="date-strcture"><a class="markdownIt-Anchor" href="#date-strcture"></a> date strcture</h2><ul><li>[x] å¹¶æŸ¥é›†</li><li>[x] Sparse table</li><li>[x] Trie, 01Trie</li><li>[x] æ ‘çŠ¶æ•°ç»„</li><li>[x] çº¿æ®µæ ‘ï¼Œæ‰«æçº¿</li><li>[x] æ ‘é“¾å‰–åˆ†</li><li>[x] å¯æŒä¹…åŒ–çº¿æ®µæ ‘ï¼Œkth number, ä¸»å¸­æ ‘</li><li>[ ] splay</li><li>[ ] åˆ†å—</li><li>[x] è«é˜Ÿ</li><li>[ ] ç‚¹åˆ†æ²»</li><li>[ ] kdtree</li></ul><h2 id="graph"><a class="markdownIt-Anchor" href="#graph"></a> Graph</h2><ul><li>[x] Floyd</li><li>[x] bellman-ford, spfaï¼Œåˆ¤è´Ÿç¯</li><li>[x] dijkstraï¼Œ æ‹†ç‚¹</li><li>[x] åˆ†å±‚å›¾æœ€çŸ­è·¯</li><li>[x] å·®åˆ†çº¦æŸ</li><li>[x] æœ€å°ç”Ÿæˆæ ‘ prim, kruskal</li><li>[x] ç“¶é¢ˆç”Ÿæˆæ ‘</li><li>[x] kruskalé‡æ„æ ‘</li><li>[x] lca</li><li>[x] äºŒåˆ†å›¾åŒ¹é…</li><li>[ ] æ¬§æ‹‰å›è·¯æ¬§æ‹‰è·¯å¾„</li><li>[x] å¼ºè¿é€šåˆ†é‡</li><li>[x] 2-sat</li><li>[ ] ç½‘ç»œæµç›¸å…³</li></ul><h2 id="string"><a class="markdownIt-Anchor" href="#string"></a> string</h2><ul><li>[x] å­—ç¬¦ä¸²hash</li><li>[x] KMPï¼Œ å‰ç¼€å‡½æ•°</li><li>[x] Z-algorithm</li><li>[x] acè‡ªåŠ¨æœº</li><li>[x] SA</li><li>[x] SAM</li></ul><h2 id="dp"><a class="markdownIt-Anchor" href="#dp"></a> dp</h2><ul><li>[x] 01pack, å®Œå…¨èƒŒåŒ…ï¼Œå¤šé‡èƒŒåŒ…åŠä¼˜åŒ–ï¼Œåˆ†ç»„èƒŒåŒ…</li><li>[x] çº¿æ€§dp, LCS, LIS, ç¼–è¾‘è·ç¦»</li><li>[x] åŒºé—´dp å­—ç¬¦ä¸²å‹ç¼©</li><li>[x] æ•°ä½dp</li><li>[ ] çŠ¶å‹dp</li><li>[x] æ ‘å½¢dp</li><li>[x] åŸºç¯æ ‘dp</li><li>[x] å•è°ƒé˜Ÿåˆ—ä¼˜åŒ–dp</li><li>[ ] æ–œç‡ä¼˜åŒ–dp</li></ul><h2 id="geometry"><a class="markdownIt-Anchor" href="#geometry"></a> Geometry</h2><ul><li>[ ] å¸¸ç”¨æ¨¡æ¿</li><li>[ ] äºŒç»´å‡¸åŒ…</li></ul><blockquote><p>githubåœ°å€ <a href="https://github.com/caaatch22/algorithm-template">https://github.com/caaatch22/algorithm-template</a></p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>icpc</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
